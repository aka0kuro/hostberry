<style>
  .security-settings-card .card-body {
    display: flex;
    flex-direction: column;
  }
  .security-settings-card .security-save-wrapper {
    margin-top: auto;
  }
  
  /* Aplicar estilos del dashboard */
  .dashboard-container {
    padding: 0;
    color: var(--hb-text-light);
    background: transparent;
    max-width: 1400px;
    margin: 0 auto;
  }
  
  .dashboard-header {
    margin-bottom: 2rem;
    padding: 1.5rem 0;
    text-align: center;
  }
  
  .dashboard-title {
    font-size: 2rem;
    font-weight: 600;
    margin: 0;
    color: var(--hb-text-light);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  body.light-theme .dashboard-title {
    color: var(--hb-primary);
  }
  
  .dashboard-subtitle {
    color: var(--hb-text-muted);
    margin: 0.5rem 0 0 0;
    font-size: 1rem;
  }
  
  body.light-theme .dashboard-subtitle {
    color: rgba(0, 0, 0, 0.7);
  }
  
  /* Cards igual que dashboard */
  .glass-card {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    backdrop-filter: blur(10px) !important;
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
    color: var(--hb-text-light);
  }
  
  body.light-theme .glass-card {
    background: rgba(255, 255, 255, 0.95) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
    color: #212529;
    backdrop-filter: blur(20px) !important;
  }
  
  .glass-card .card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: transparent;
  }
  
  body.light-theme .glass-card .card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    background: rgba(255, 255, 255, 0.05);
  }
  
  .glass-card .card-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    color: var(--hb-text-light);
    display: flex;
    align-items: center;
  }
  
  body.light-theme .glass-card .card-title {
    color: var(--hb-primary) !important;
  }
  
  .glass-card .card-body {
    padding: 1.5rem;
    flex: 1;
    color: var(--hb-text-light);
  }
  
  body.light-theme .glass-card .card-body {
    color: #212529;
  }
  
  body.light-theme .glass-card .form-label {
    color: #212529;
  }
  
  body.light-theme .glass-card .text-white-50 {
    color: rgba(0, 0, 0, 0.6) !important;
  }
</style>

<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-12 text-center">
                <h1 class="dashboard-title">
                    <i class="bi bi-gear me-2"></i>
                    {{ call .t "navigation.settings" "Settings" }}
                </h1>
                <p class="dashboard-subtitle">{{ call .t "settings.subtitle" "Configure your HostBerry system preferences" }}</p>
            </div>
        </div>
    </div>

    <div class="row settings-cards-row">
        <!-- ConfiguraciÃ³n General -->
        <div class="col-12 settings-card general-settings-card">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-center align-items-center">
                    <h5 class="card-title mb-0 fw-bold text-center d-flex align-items-center justify-content-center">
                        <i class="bi bi-gear me-2"></i>{{ call .t "settings.general" "General" }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <form id="generalConfigForm">
                        <div class="mb-3">
                            <label for="language" class="form-label text-white">{{ call .t "settings.language" "Language" }}</label>
                            <select class="form-select form-select-custom bg-white text-dark border-secondary" id="language" name="language" style="width: 100%; background-color: #ffffff !important;">
                                {{ $current_lang := index .settings "language" }}
                                {{ if eq $current_lang "" }}{{ $current_lang = .language }}{{ end }}
                                <option value="es" {{ if eq $current_lang "es" }}selected{{ end }}>ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                                <option value="en" {{ if eq $current_lang "en" }}selected{{ end }}>ðŸ‡ºðŸ‡¸ English</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="theme" class="form-label text-white">{{ call .t "settings.theme" "Theme" }}</label>
                            <select class="form-select form-select-custom bg-white text-dark border-secondary" id="theme" name="theme" style="width: 100%; background-color: #ffffff !important;">
                                {{ $current_theme := index .settings "theme" }}
                                {{ if eq $current_theme "" }}{{ $current_theme = "dark" }}{{ end }}
                                <option value="light" {{ if eq $current_theme "light" }}selected{{ end }}>{{ call .t "settings.theme_light" "Light" }}</option>
                                <option value="dark" {{ if eq $current_theme "dark" }}selected{{ end }}>{{ call .t "settings.theme_dark" "Dark" }}</option>
                                <option value="auto" {{ if eq $current_theme "auto" }}selected{{ end }}>{{ call .t "settings.theme_auto" "Auto" }}</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="timezone" class="form-label text-white">{{ call .t "settings.timezone" "Timezone" }}</label>
                            <div class="timezone-selector-wrapper position-relative" style="width: 100%;">
                                <input type="text" 
                                       class="form-control bg-white text-dark border-secondary text-center" 
                                       id="timezone_search" 
                                       placeholder="{{ call .t "settings.search_timezone" "Search timezone..." }}"
                                       autocomplete="off"
                                       style="background-color: #ffffff !important;">
                                {{ $tz := index .settings "timezone" }}
                                <input type="hidden" id="timezone" name="timezone" value="{{ if $tz }}{{ $tz }}{{ else }}UTC{{ end }}">
                                <div class="timezone-dropdown bg-dark border border-secondary rounded mt-1 position-absolute w-100" 
                                     id="timezone_dropdown" 
                                     style="display: none; max-height: 300px; overflow-y: auto; z-index: 1000;">
                                    <div class="text-center text-white-50 p-2">
                                        <i class="bi bi-arrow-clockwise spinning"></i> {{ call .t "settings.loading_timezones" "Loading timezones..." }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                {{ call .t "common.save" "Save" }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ConfiguraciÃ³n de Red -->
        <div class="col-12 settings-card">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-center align-items-center">
                    <h5 class="card-title mb-0 fw-bold text-center d-flex align-items-center justify-content-center">
                        <i class="bi bi-wifi me-2"></i>{{ call .t "settings.network" "Network" }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <form id="networkConfigForm">
                        <div class="mb-3">
                            <label class="form-label text-white">{{ call .t "settings.dhcp_server" "DHCP Server" }}</label>
                            <div class="form-check form-switch">
                                {{ $dhcp := index .settings "dhcp_enabled" }}
                                <input class="form-check-input" type="checkbox" id="dhcp_enabled" name="dhcp_enabled" {{ if eq $dhcp "true" }}checked{{ end }}>
                                <label class="form-check-label text-white" for="dhcp_enabled">
                                    {{ call .t "settings.enable_dhcp" "Enable DHCP server" }}
                                </label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="dhcp_interface" class="form-label text-white">{{ call .t "settings.dhcp_interface" "DHCP Interface" }}</label>
                                <select class="form-select form-select-custom bg-white text-dark border-secondary text-center" id="dhcp_interface" name="dhcp_interface" style="background-color: #ffffff !important;">
                                    <option value="">{{ call .t "settings.loading_interfaces" "Loading interfaces..." }}</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="dhcp_range_start" class="form-label text-white">{{ call .t "settings.dhcp_range_start" "Range Start" }}</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="dhcp_range_start" name="dhcp_range_start" value="{{ index .settings "dhcp_range_start" }}" placeholder="192.168.1.100">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="dhcp_range_end" class="form-label text-white">{{ call .t "settings.dhcp_range_end" "Range End" }}</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="dhcp_range_end" name="dhcp_range_end" value="{{ index .settings "dhcp_range_end" }}" placeholder="192.168.1.200">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dhcp_gateway" class="form-label text-white">{{ call .t "settings.dhcp_gateway" "Gateway (router)" }}</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="dhcp_gateway" name="dhcp_gateway" value="{{ index .settings "dhcp_gateway" }}" placeholder="192.168.1.1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dhcp_lease_time" class="form-label text-white">{{ call .t "settings.dhcp_lease_time" "Lease Time" }}</label>
                                {{ $lease := index .settings "dhcp_lease_time" }}
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="dhcp_lease_time" name="dhcp_lease_time" value="{{ if $lease }}{{ $lease }}{{ else }}12h{{ end }}" placeholder="12h">
                                <small class="text-white-50">{{ call .t "settings.dhcp_lease_hint" "Example: 12h, 30m, 1d" }}</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dns_primary" class="form-label text-white">{{ call .t "settings.dns_primary" "Primary DNS" }}</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary text-center" id="dns_primary" name="dns_primary" placeholder="8.8.8.8">
                        </div>
                            <div class="col-md-6 mb-3">
                                <label for="dns_secondary" class="form-label text-white">{{ call .t "settings.dns_secondary" "Secondary DNS" }}</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary text-center" id="dns_secondary" name="dns_secondary" placeholder="8.8.4.4">
                            </div>
                        </div>
                        <!-- Campo oculto para mantener compatibilidad con el backend -->
                        <input type="hidden" id="dns_server" name="dns_server" value="{{ index .settings "dns_server" }}">
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                {{ call .t "common.save" "Save" }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ConfiguraciÃ³n de Seguridad -->
        <div class="col-lg-6 col-md-12 settings-card security-settings-card">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-center align-items-center">
                    <h5 class="card-title mb-0 fw-bold text-center d-flex align-items-center justify-content-center">
                        <i class="bi bi-shield-check me-2"></i>{{ call .t "settings.security" "Security" }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4 d-flex flex-column">
                    <form id="securityConfigForm" class="d-flex flex-column flex-grow-1">
                        <div class="mb-3">
                            <label for="max_login_attempts" class="form-label text-white">{{ call .t "settings.max_login_attempts" "Max Login Attempts" }}</label>
                            {{ $max_attempts := index .settings "max_login_attempts" }}
                            <input type="number" class="form-control bg-dark text-white border-secondary text-center" id="max_login_attempts" name="max_login_attempts" value="{{ if $max_attempts }}{{ $max_attempts }}{{ else }}3{{ end }}" min="1" max="10">
                        </div>
                        
                        <div class="mb-3">
                            <label for="session_timeout" class="form-label text-white">{{ call .t "settings.session_timeout" "Session Timeout" }}</label>
                            {{ $timeout := index .settings "session_timeout" }}
                            <input type="number" class="form-control bg-dark text-white border-secondary text-center" id="session_timeout" name="session_timeout" value="{{ if $timeout }}{{ $timeout }}{{ else }}30{{ end }}" min="5" max="1440">
                            <small class="text-white-50">{{ call .t "settings.minutes" "minutes" }}</small>
                        </div>
                    </form>

                    <div class="d-grid security-save-wrapper">
                        <button type="submit" class="btn btn-primary" form="securityConfigForm">
                            <i class="bi bi-check-circle me-2"></i>
                            {{ call .t "common.save" "Save" }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ConfiguraciÃ³n de Rendimiento -->
        <div class="col-lg-6 col-md-12 settings-card">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-center align-items-center">
                    <h5 class="card-title mb-0 fw-bold text-center d-flex align-items-center justify-content-center">
                        <i class="bi bi-speedometer2 me-2"></i>{{ call .t "settings.performance" "Performance" }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <form id="performanceConfigForm">
                        <div class="mb-3">
                            <label class="form-label text-white">{{ call .t "settings.cache" "Cache" }}</label>
                            <div class="form-check form-switch">
                                {{ $cache := index .settings "cache_enabled" }}
                                <input class="form-check-input" type="checkbox" id="cache_enabled" name="cache_enabled" {{ if eq $cache "true" }}checked{{ end }}>
                                <label class="form-check-label text-white" for="cache_enabled">
                                    {{ call .t "settings.enable_cache" "Enable cache" }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cache_size" class="form-label text-white">{{ call .t "settings.cache_size" "Cache Size" }}</label>
                            {{ $cache_size := index .settings "cache_size" }}
                            <input type="number" class="form-control bg-dark text-white border-secondary" id="cache_size" name="cache_size" value="{{ if $cache_size }}{{ $cache_size }}{{ else }}50{{ end }}" min="10" max="500">
                            <small class="text-white-50">{{ call .t "settings.mb" "MB" }}</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label text-white">{{ call .t "settings.compression" "Compression" }}</label>
                            <div class="form-check form-switch">
                                {{ $compression := index .settings "compression_enabled" }}
                                <input class="form-check-input" type="checkbox" id="compression_enabled" name="compression_enabled" {{ if eq $compression "true" }}checked{{ end }}>
                                <label class="form-check-label text-white" for="compression_enabled">
                                    {{ call .t "settings.enable_compression" "Enable compression" }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                {{ call .t "common.save" "Save" }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ConfiguraciÃ³n de Notificaciones -->
        <div class="col-12 settings-card">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-center align-items-center">
                    <h5 class="card-title mb-0 fw-bold text-center d-flex align-items-center justify-content-center">
                        <i class="bi bi-bell me-2"></i>{{ call .t "settings.notifications" "Notifications" }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <form id="notificationConfigForm">
                        <div class="mb-3">
                            <label class="form-label text-white d-flex align-items-center justify-content-between">
                                <span>{{ call .t "settings.email_notifications" "Email Notifications" }}</span>
                            <div class="form-check form-switch">
                                {{ $email_notif := index .settings "email_notifications" }}
                                <input class="form-check-input" type="checkbox" id="email_notifications" name="email_notifications" {{ if eq $email_notif "true" }}checked{{ end }}>
                                    <label class="form-check-label text-white" for="email_notifications"></label>
                                </div>
                                </label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email_address" class="form-label text-white">{{ call .t "settings.email_address" "Email Address" }}</label>
                            <input type="email" class="form-control bg-dark text-white border-secondary" id="email_address" name="email_address" value="{{ index .settings "email_address" }}">
                        </div>

                        <hr class="border-secondary">

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="smtp_host" class="form-label text-white">{{ call .t "settings.smtp_host" "SMTP Host" }}</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="smtp_host" name="smtp_host" value="{{ index .settings "smtp_host" }}" placeholder="smtp.gmail.com">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="smtp_port" class="form-label text-white">{{ call .t "settings.smtp_port" "SMTP Port" }}</label>
                                {{ $port := index .settings "smtp_port" }}
                                <input type="number" class="form-control bg-dark text-white border-secondary" id="smtp_port" name="smtp_port" value="{{ if $port }}{{ $port }}{{ else }}587{{ end }}" min="1" max="65535">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="smtp_user" class="form-label text-white">{{ call .t "settings.smtp_user" "SMTP User" }}</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="smtp_user" name="smtp_user" value="{{ index .settings "smtp_user" }}">
                        </div>

                        <div class="mb-3">
                            <label for="smtp_password" class="form-label text-white">{{ call .t "settings.smtp_password" "SMTP Password" }}</label>
                            <input type="password" class="form-control bg-dark text-white border-secondary" id="smtp_password" name="smtp_password" value="{{ index .settings "smtp_password" }}" autocomplete="new-password">
                            <small class="text-white-50">{{ call .t "settings.smtp_password_hint" "If you use Gmail, use an App Password" }}</small>
                        </div>

                        <div class="mb-3">
                            <label for="smtp_from" class="form-label text-white">{{ call .t "settings.smtp_from" "From Email" }}</label>
                            <input type="email" class="form-control bg-dark text-white border-secondary" id="smtp_from" name="smtp_from" value="{{ index .settings "smtp_from" }}" placeholder="hostberry@tu-dominio.com">
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-white">{{ call .t "settings.smtp_tls" "Use TLS (STARTTLS)" }}</label>
                            <div class="form-check form-switch">
                                {{ $tls := index .settings "smtp_tls" }}
                                <input class="form-check-input" type="checkbox" id="smtp_tls" name="smtp_tls" {{ if eq $tls "true" }}checked{{ end }}>
                                <label class="form-check-label text-white" for="smtp_tls">
                                    {{ call .t "settings.enable_smtp_tls" "Enable TLS" }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label text-white">{{ call .t "settings.system_alerts" "System Alerts" }}</label>
                            <div class="form-check form-switch">
                                {{ $alerts := index .settings "system_alerts" }}
                                <input class="form-check-input" type="checkbox" id="system_alerts" name="system_alerts" {{ if eq $alerts "true" }}checked{{ end }}>
                                <label class="form-check-label text-white" for="system_alerts">
                                    {{ call .t "settings.enable_system_alerts" "Enable system alerts" }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                {{ call .t "common.save" "Save" }}
                            </button>
                        </div>
                    </form>

                    <div class="d-grid mt-3">
                        <button type="button" class="btn btn-outline-info" id="sendTestEmailBtn">
                            <i class="bi bi-send me-2"></i>
                            {{ call .t "settings.send_test_email" "Send test email" }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- InformaciÃ³n del Sistema -->
        <div class="col-12 settings-card">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-center align-items-center">
                    <h5 class="card-title mb-0 fw-bold text-center d-flex align-items-center justify-content-center">
                        <i class="bi bi-info-circle me-2"></i>{{ call .t "settings.about" "About" }}
                    </h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <div class="row">
                        <div class="col-md-4 mb-3 text-center">
                            <h6 class="text-white">{{ call .t "settings.version" "Version" }}</h6>
                            <p class="text-white-50">1.0.0 (Go)</p>
                            
                            <h6 class="text-white mt-3">{{ call .t "system.hostname" "Hostname" }}</h6>
                            <p class="text-white-50" id="about-hostname">--</p>
                            
                            <h6 class="text-white mt-3">{{ call .t "system.architecture" "Architecture" }}</h6>
                            <p class="text-white-50" id="about-architecture">--</p>
                        </div>
                        <div class="col-md-4 mb-3 text-center">
                            <h6 class="text-white">{{ call .t "system.os" "OS" }}</h6>
                            <p class="text-white-50" id="about-os">--</p>
                            
                            <h6 class="text-white mt-3">{{ call .t "system.kernel" "Kernel" }}</h6>
                            <p class="text-white-50" id="about-kernel">--</p>
                            
                            <h6 class="text-white mt-3">{{ call .t "monitoring.processor" "Processor" }}</h6>
                            <p class="text-white-50" id="about-processor">--</p>
                        </div>
                        <div class="col-md-4 mb-3 text-center">
                            <h6 class="text-white">{{ call .t "monitoring.uptime" "Uptime" }}</h6>
                            <p class="text-white-50" id="about-uptime">--</p>
                            
                            <h6 class="text-white mt-3">{{ call .t "system.boot_time" "Boot Time" }}</h6>
                            <p class="text-white-50" id="about-boot-time">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
  // Notificaciones estilo dashboard (toast)
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <span class="notification-message">${message || ''}</span>
        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
      </div>
    `;
    
    if (!document.querySelector('#notification-styles')) {
      const style = document.createElement('style');
      style.id = 'notification-styles';
      style.textContent = `
        .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          min-width: 300px;
          padding: 1rem;
          border-radius: 12px;
          background: rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          animation: slideInRight 0.3s ease;
        }
        .notification-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: #fff;
        }
        .notification-close {
          background: none;
          border: none;
          color: #fff;
          font-size: 1.2rem;
          cursor: pointer;
          padding: 0;
          margin-left: 1rem;
        }
        .notification-success { border-left: 4px solid #198754; }
        .notification-error { border-left: 4px solid #6c757d; }
        .notification-warning { border-left: 4px solid #ffc107; }
        .notification-info { border-left: 4px solid #0dcaf0; }
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        body.light-theme .notification {
          background: rgba(255, 255, 255, 0.95);
          color: #212529;
          border: 1px solid rgba(0, 0, 0, 0.1);
        }
        body.light-theme .notification-content { color: #212529; }
        body.light-theme .notification-close { color: #212529; }
      `;
      document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    setTimeout(() => {
      if (notification.parentElement) notification.remove();
    }, 5000);
  }

  function t(key, fallback) {
    return window.HostBerry?.t ? window.HostBerry.t(key, fallback) : (fallback || key);
  }

  // FunciÃ³n para bindear formularios
  function bindForm(formId, endpoint){
    const form = document.getElementById(formId);
    if(!form) return;
    
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      
      // Construir payload robusto (incluye checkboxes aunque estÃ©n apagados)
      const obj = {};
      const elements = Array.from(form.elements || []);
      for(const el of elements){
        if(!el || !el.name || el.disabled) continue;
        const name = el.name;
        const type = (el.type || '').toLowerCase();
        
        // Omitir dns_primary, dns_secondary y el campo hidden dns_server del loop
        if(formId === 'networkConfigForm' && (name === 'dns_primary' || name === 'dns_secondary' || (name === 'dns_server' && type === 'hidden'))){
          continue;
        }
        
        if(type === 'checkbox'){
          obj[name] = !!el.checked;
        } else if(type === 'number'){
          obj[name] = el.value === '' ? null : parseInt(el.value, 10);
        } else {
          obj[name] = el.value;
        }
      }
      
      // Combinar DNS primario y secundario en dns_server para el backend (solo para networkConfigForm)
      if(formId === 'networkConfigForm'){
        const dnsPrimary = document.getElementById('dns_primary')?.value?.trim() || '';
        const dnsSecondary = document.getElementById('dns_secondary')?.value?.trim() || '';
        if(dnsPrimary){
          obj['dns_server'] = dnsSecondary ? `${dnsPrimary},${dnsSecondary}` : dnsPrimary;
        }
      }

      showNotification(t('settings.saving', 'Saving...'), 'info');
      
      try{
        const resp = await HostBerry.apiRequest(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: obj
        });

        if(!resp || !resp.ok){
          const errorData = await resp.json().catch(() => ({}));
          const errorMsg = errorData.detail || errorData.message || t('errors.configuration_error', 'Error saving configuration');
          showNotification(errorMsg, 'error');
          return;
        }

        const data = await resp.json().catch(() => ({}));
        let message = data.message || t('settings.saved', 'Settings saved successfully');
        const extraErrors = Array.isArray(data.errors) ? data.errors.filter(Boolean) : [];
        if (extraErrors.length && !String(message).includes('Algunos errores')) {
          message += ` (Algunos errores: ${extraErrors.join(', ')})`;
        }
        showNotification(message, extraErrors.length ? 'warning' : 'success');
          
        // Aplicar cambios UX
          if(formId === 'generalConfigForm'){
            setTimeout(() => {
              if(obj.language){
              const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('lang', obj.language);
                window.location.href = currentUrl.toString();
              return;
            }
            if(obj.theme){
              if(obj.theme === 'auto'){
                localStorage.removeItem('theme');
                window.ThemeManager?.initTheme?.();
                } else {
                window.ThemeManager?.setTheme?.(obj.theme);
              }
            }
              if(obj.timezone){
              showNotification(t('settings.timezone_updated', 'Timezone updated. Changes will take effect on next page reload.'), 'info');
              // Aplicar en todo el proyecto: recargar para que base.html exporte el nuevo timezone a JS global.
              setTimeout(() => window.location.reload(), 800);
            }
          }, 600);
        }
      } catch(error){
        console.error('Error saving settings:', error);
        showNotification(t('errors.network_error', 'Network error. Please try again.'), 'error');
      }
    });
  }

  // Bindear todos los formularios
  bindForm('generalConfigForm', '/api/v1/system/config');
  bindForm('networkConfigForm', '/api/v1/system/config');
  bindForm('securityConfigForm', '/api/v1/system/config');
  bindForm('performanceConfigForm', '/api/v1/system/config');
  bindForm('notificationConfigForm', '/api/v1/system/config');

  // Email de prueba
  const testBtn = document.getElementById('sendTestEmailBtn');
  if (testBtn) {
    testBtn.addEventListener('click', async function () {
      try {
        const to = (document.getElementById('email_address')?.value || '').trim();
        if (!to) {
          showNotification(t('settings.test_email_missing_to', 'Please enter an email address first.'), 'warning');
          return;
        }

        showNotification(t('settings.sending_test_email', 'Sending test email...'), 'info');
        const resp = await HostBerry.apiRequest('/api/v1/system/notifications/test-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: { to }
        });
        const msg = resp?.message || t('settings.test_email_sent', 'Test email sent.');
        showNotification(msg, 'success');
      } catch (e) {
        console.error('Test email error:', e);
        const detail = (e && (e.detail || e.message)) ? (e.detail || e.message) : '';
        showNotification(detail || t('settings.test_email_failed', 'Failed to send test email.'), 'error');
      }
    });
  }

  // FunciÃ³n para formatear uptime
  function formatUptime(seconds) {
    if (typeof seconds !== 'number' || !isFinite(seconds) || seconds < 0) return '--';
    const mins = Math.floor(seconds / 60);
    const hrs = Math.floor(mins / 60);
    const days = Math.floor(hrs / 24);
    const remHrs = hrs % 24;
    const remMins = mins % 60;
    if (days > 0) return `${days}d ${remHrs}h ${remMins}m`;
    if (hrs > 0) return `${hrs}h ${remMins}m`;
    return `${remMins}m`;
  }

  // Cargar datos de sistema para "Acerca de"
  async function loadSystemInfo() {
    console.log('Loading system info...');
    try {
      const apiRequestFn = window.HostBerry && window.HostBerry.apiRequest 
        ? window.HostBerry.apiRequest 
        : async function(url) {
            const token = localStorage.getItem('access_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
              headers['Authorization'] = 'Bearer ' + token;
            }
            const response = await fetch(url, { headers: headers });
            return response;
          };
      
      // Obtener stats e info en paralelo
      const [statsResp, infoResp] = await Promise.all([
        apiRequestFn('/api/v1/system/stats'),
        apiRequestFn('/api/v1/system/info')
      ]);
      
      let stats = {};
      let info = {};
      
      if (statsResp && statsResp.ok) {
        stats = await statsResp.json().catch((e) => {
          console.error('Error parsing stats JSON:', e);
          return {};
        });
        console.log('Stats response:', stats);
      } else {
        console.error('Stats request failed:', statsResp ? statsResp.status : 'No response');
      }
      
      if (infoResp && infoResp.ok) {
        info = await infoResp.json().catch((e) => {
          console.error('Error parsing info JSON:', e);
          return {};
        });
        console.log('Info response:', info);
      } else {
        console.error('Info request failed:', infoResp ? infoResp.status : 'No response');
      }
      
      // Combinar datos de ambos endpoints
      const hostname = info.hostname || stats.hostname || '--';
      const architecture = info.architecture || stats.architecture || '--';
      const osVersion = info.os_version || stats.os_version || '--';
      const kernel = info.kernel_version || info.kernel || stats.kernel_version || stats.kernel || '--';
      const processor = info.processor || stats.processor || '--';
      const uptimeSeconds = info.uptime_seconds || stats.uptime || stats.uptime_seconds || 0;
      
      console.log('Updating DOM with:', { hostname, architecture, osVersion, kernel, processor, uptimeSeconds });
      
      // Actualizar datos del sistema
      const hostnameEl = document.getElementById('about-hostname');
      if (hostnameEl) {
        hostnameEl.textContent = hostname;
      } else {
        console.warn('about-hostname element not found');
      }
      
      const archEl = document.getElementById('about-architecture');
      if (archEl) archEl.textContent = architecture;
      
      const osEl = document.getElementById('about-os');
      if (osEl) osEl.textContent = osVersion;
      
      const kernelEl = document.getElementById('about-kernel');
      if (kernelEl) kernelEl.textContent = kernel;
      
      const procEl = document.getElementById('about-processor');
      if (procEl) procEl.textContent = processor;

      // Actualizar uptime
      if (uptimeSeconds !== undefined) {
        const uptimeEl = document.getElementById('about-uptime');
        if (uptimeEl) {
          uptimeEl.textContent = formatUptime(uptimeSeconds);
        }
      }
      
      // Actualizar boot time (calculado)
      if (uptimeSeconds !== undefined) {
        const bootTimeEl = document.getElementById('about-boot-time');
        if (bootTimeEl) {
          const bootTimestamp = Math.floor(Date.now() / 1000) - uptimeSeconds;
          const bootDate = new Date(bootTimestamp * 1000);
          bootTimeEl.textContent = bootDate.toLocaleString();
        }
      }
    } catch (error) {
      console.error('Error loading system info:', error);
    }
  }

  // Cargar datos al iniciar
  document.addEventListener('DOMContentLoaded', function() {
    loadSystemInfo();
  });
  
  // TambiÃ©n intentar cargar despuÃ©s de un pequeÃ±o delay por si HostBerry aÃºn no estÃ¡ listo
  setTimeout(loadSystemInfo, 500);
  
  // Actualizar cada 30 segundos
  setInterval(loadSystemInfo, 30000);

  // Cargar interfaces de red para el desplegable DHCP
  async function loadNetworkInterfaces() {
    const select = document.getElementById('dhcp_interface');
    if (!select) {
      console.error('dhcp_interface select not found');
      return;
    }

    console.log('Loading network interfaces...');
    try {
      const apiRequestFn = window.HostBerry && window.HostBerry.apiRequest 
        ? window.HostBerry.apiRequest 
        : async function(url) {
            const token = localStorage.getItem('access_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
              headers['Authorization'] = 'Bearer ' + token;
            }
            const response = await fetch(url, { headers: headers });
            return response;
          };
      
      const resp = await apiRequestFn('/api/v1/network/interfaces');

      if (resp && resp.ok) {
        const result = await resp.json().catch((e) => {
          console.error('Error parsing JSON:', e);
          return {};
        });
        console.log('Network interfaces response:', result);
        const interfaces = result.interfaces || [];
        
        // Limpiar opciones existentes
        select.innerHTML = '';
        
        if (interfaces && interfaces.length > 0) {
          console.log('Found interfaces:', interfaces.length);
          // Agregar opciÃ³n vacÃ­a inicial
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = t('settings.select_interface', 'Select interface...');
          select.appendChild(emptyOption);
          
          // Agregar cada interfaz como opciÃ³n
          interfaces.forEach(iface => {
            if (!iface || !iface.name) {
              console.warn('Invalid interface:', iface);
              return;
            }
            const option = document.createElement('option');
            option.value = iface.name;
            const displayText = iface.ip && iface.ip !== 'N/A' && iface.ip !== '' 
              ? iface.name + ' (' + iface.ip + ')' 
              : iface.name;
            option.textContent = displayText;
            select.appendChild(option);
          });
        } else {
          console.warn('No interfaces found');
          select.innerHTML = '<option value="">' + t('network.no_interfaces', 'No interfaces found') + '</option>';
        }
      } else {
        console.error('Failed to load interfaces:', resp ? resp.status : 'No response');
        select.innerHTML = '<option value="">Error loading interfaces</option>';
      }
    } catch (error) {
      console.error('Error loading network interfaces:', error);
      const select = document.getElementById('dhcp_interface');
      if (select) {
        select.innerHTML = '<option value="">Error: ' + error.message + '</option>';
      }
    }
  }

  // Cargar interfaces al iniciar
  document.addEventListener('DOMContentLoaded', function() {
    loadNetworkInterfaces();
  });
  
  // TambiÃ©n intentar cargar despuÃ©s de un pequeÃ±o delay por si HostBerry aÃºn no estÃ¡ listo
  setTimeout(loadNetworkInterfaces, 500);

  // Separar DNS actual en primario y secundario
  function loadDNSValues() {
    const dnsServerValue = document.getElementById('dns_server')?.value;
    const dnsPrimaryInput = document.getElementById('dns_primary');
    const dnsSecondaryInput = document.getElementById('dns_secondary');
    
    if (dnsServerValue && dnsPrimaryInput && dnsSecondaryInput) {
      // Separar por coma o espacio
      const parts = dnsServerValue.split(/[,\s]+/).map(p => p.trim()).filter(p => p);
      if (parts.length > 0) dnsPrimaryInput.value = parts[0];
      if (parts.length > 1) dnsSecondaryInput.value = parts[1];
    }
  }
  
  // Ejecutar carga de DNS
  loadDNSValues();

  // Setup de Timezone Search con autocompletado simple
  (function(){
    const input = document.getElementById('timezone_search');
    const hidden = document.getElementById('timezone');
    const dropdown = document.getElementById('timezone_dropdown');
    if(!input || !dropdown) return;

    let timezones = []; // Se cargarÃ¡ dinÃ¡micamente

    // Cargar timezones (simulado o desde API si existiera endpoint, por ahora lista estÃ¡tica comÃºn)
    // Para una implementaciÃ³n real completa se necesitarÃ­a un endpoint de timezones.
    // Usaremos una lista bÃ¡sica.
    const commonTimezones = [
        "UTC", "America/New_York", "America/Los_Angeles", "America/Chicago", "America/Denver",
        "Europe/London", "Europe/Paris", "Europe/Berlin", "Europe/Madrid", "Europe/Rome",
        "Asia/Tokyo", "Asia/Shanghai", "Asia/Singapore", "Australia/Sydney", "Pacific/Auckland"
    ];
    timezones = commonTimezones;

    input.addEventListener('focus', () => {
        renderDropdown(timezones);
        dropdown.style.display = 'block';
    });

    input.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = timezones.filter(tz => tz.toLowerCase().includes(term));
        renderDropdown(filtered);
        dropdown.style.display = 'block';
    });

    // Cerrar al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    function renderDropdown(items) {
        dropdown.innerHTML = '';
        if (items.length === 0) {
            const div = document.createElement('div');
            div.className = 'text-white-50 p-2 text-center';
            div.textContent = 'No results';
            dropdown.appendChild(div);
            return;
        }
        items.forEach(tz => {
            const div = document.createElement('div');
            div.className = 'p-2 text-white cursor-pointer hover-bg-secondary';
            div.textContent = tz;
            div.style.cursor = 'pointer';
            div.onmouseover = () => div.style.backgroundColor = '#444';
            div.onmouseout = () => div.style.backgroundColor = 'transparent';
            div.onclick = () => {
                input.value = tz;
                if(hidden) hidden.value = tz;
                dropdown.style.display = 'none';
            };
            dropdown.appendChild(div);
        });
    }
    
    // Set initial value if hidden has one
    if(hidden && hidden.value) input.value = hidden.value;
  })();

})();
</script>
