{% extends "base.html" %}

{% block extra_css %}
<style>
    .security-page .glass-card {
        border-radius: 24px;
        background: rgba(12, 15, 32, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
    }
    .security-page .hero-card {
        background: radial-gradient(circle at top left, rgba(99, 102, 241, 0.25), transparent),
                    radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.25), transparent),
                    rgba(15, 18, 40, 0.9);
    }
    .security-page .status-pill {
        padding: 0.4rem 1rem;
        border-radius: 999px;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .security-page .metric-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .security-page .metric-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .security-page .metric-list li:last-child {
        border-bottom: none;
    }
    .security-page .metric-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
    }
    .security-page .metric-value {
        font-weight: 600;
    }
    .security-page .badge-status {
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
    }
    .security-page .logs-container {
        max-height: 380px;
        overflow-y: auto;
    }
    .security-page .log-item {
        padding: 0.75rem 1rem;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .security-page .log-item:last-child {
        margin-bottom: 0;
    }
    .security-page .log-level {
        min-width: 80px;
        text-transform: uppercase;
        font-size: 0.7rem;
    }
    .security-page .backup-list .backup-item {
        padding: 0.75rem 1rem;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
    }
    .security-page .backup-list .backup-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }
    .security-page .backup-list .backup-item:last-child {
        margin-bottom: 0;
    }
    .security-page .service-item {
        padding: 0.5rem 0.75rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .security-page .service-item:last-child {
        margin-bottom: 0;
    }
    .security-page .service-name {
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
    }
    .security-page .spinning {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="system-page security-page">
    <div class="dashboard-container">
        <section class="glass-card hero-card p-4 mb-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                <div>
                    <p class="text-uppercase text-primary fw-semibold small mb-2">{{ t('security.kicker', 'Security overview') }}</p>
                    <h2 class="text-white fw-bold mb-2">{{ t('security.title', 'Security Command Center') }}</h2>
                    <p class="text-white-50 mb-0">{{ t('security.subtitle', 'Monitor audit, rate limiting and backup posture in real time') }}</p>
                </div>
                <div class="text-end">
                    <div class="text-white-50 small">{{ t('security.last_check', 'Last check') }} <span id="security-last-check">--</span></div>
                    <div class="status-pill bg-opacity-25 bg-success text-white mt-2" id="security-overall-pill">{{ t('security.status_ok', 'All systems nominal') }}</div>
                </div>
            </div>
        </section>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="glass-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-white mb-0">{{ t('security.controls_heading', 'Controls status') }}</h5>
                        <button class="btn btn-sm btn-outline-light" id="securityStatusRefresh">
                            <i class="bi bi-arrow-clockwise me-1"></i>{{ t('common.refresh', 'Refresh') }}
                        </button>
                    </div>
                    <ul class="metric-list text-white">
                        <li>
                            <span class="metric-label">{{ t('security.audit_logging', 'Audit logging') }}</span>
                            <span class="badge-status bg-secondary" id="status-audit">--</span>
                        </li>
                        <li>
                            <span class="metric-label">{{ t('security.rate_limit', 'Rate limiting') }}</span>
                            <span class="badge-status bg-secondary" id="status-rate">--</span>
                        </li>
                        <li>
                            <span class="metric-label">{{ t('security.security_headers', 'Security headers') }}</span>
                            <span class="badge-status bg-secondary" id="status-headers">--</span>
                        </li>
                        <li>
                            <span class="metric-label">{{ t('security.backup_encryption', 'Backup encryption') }}</span>
                            <span class="badge-status bg-secondary" id="status-backup">--</span>
                        </li>
                        <li>
                            <span class="metric-label">{{ t('security.two_factor', 'Two-factor auth') }}</span>
                            <span class="badge-status bg-secondary" id="status-2fa">--</span>
                        </li>
                        <li>
                            <span class="metric-label">{{ t('security.ip_lists', 'IP blacklist / whitelist') }}</span>
                            <span class="badge-status bg-secondary" id="status-ip-lists">--</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="glass-card p-4 h-100">
                    <h5 class="text-white mb-3">{{ t('security.actions_heading', 'Quick actions') }}</h5>
                    <div class="d-grid gap-3">
                        <button class="btn btn-light text-start d-flex justify-content-between align-items-center" id="action-create-backup">
                            <span><i class="bi bi-hdd-network me-2 text-primary"></i>{{ t('security.create_backup', 'Create encrypted backup') }}</span>
                            <i class="bi bi-arrow-right-short"></i>
                        </button>
                        <button class="btn btn-outline-light text-start d-flex justify-content-between align-items-center" id="action-list-backups">
                            <span><i class="bi bi-archive me-2 text-info"></i>{{ t('security.list_backups', 'List backups') }}</span>
                            <i class="bi bi-arrow-right-short"></i>
                        </button>
                        <button class="btn btn-outline-light text-start d-flex justify-content-between align-items-center" id="action-validate-input">
                            <span><i class="bi bi-search me-2 text-warning"></i>{{ t('security.validate_input', 'Validate input sanitization') }}</span>
                            <i class="bi bi-arrow-right-short"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-1">
            <div class="col-xl-4">
                <div class="glass-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-white mb-0">{{ t('security.active_services', 'Active Services') }}</h5>
                        <button class="btn btn-sm btn-outline-light" id="servicesRefresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div id="services-list">
                        <div class="text-center py-4 text-white-50">
                            <i class="bi bi-arrow-clockwise spinning"></i>
                            <p class="mb-0 mt-2">{{ t('security.loading_services', 'Loading services...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="glass-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="text-white mb-1">{{ t('security.logs_heading', 'Security logs') }}</h5>
                            <p class="text-white-50 mb-0 small">{{ t('security.logs_caption', 'Filter critical events in real time') }}</p>
                        </div>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm bg-dark text-white border-secondary" id="securityLogLevel">
                                <option value="warning">{{ t('security.logs_warnings', 'Warnings') }}</option>
                                <option value="error">{{ t('security.logs_errors', 'Errors') }}</option>
                                <option value="info">{{ t('security.logs_info', 'Info') }}</option>
                                <option value="all">{{ t('security.logs_all', 'All') }}</option>
                            </select>
                            <button class="btn btn-sm btn-outline-light" id="securityLogsRefresh"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                    </div>
                    <div class="logs-container" id="security-logs">
                        <div class="text-center py-4 text-white-50">
                            <i class="bi bi-arrow-clockwise spinning"></i>
                            <p class="mb-0 mt-2">{{ t('security.loading_logs', 'Loading logs...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="glass-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="text-white mb-1">{{ t('security.backups_heading', 'Backup inventory') }}</h5>
                            <p class="text-white-50 mb-0 small">{{ t('security.backups_caption', 'Latest encrypted backups stored on device') }}</p>
                        </div>
                        <button class="btn btn-sm btn-outline-light" id="securityBackupsRefresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="backup-list" id="security-backup-list">
                        <div class="text-center py-4 text-white-50">
                            <i class="bi bi-database"></i>
                            <p class="mb-0 mt-2">{{ t('security.no_backups', 'No backups listed yet') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const setBadge = (id, enabled) => {
    const el = document.getElementById(id);
    if(!el) return;
    const isOn = !!enabled;
    el.className = 'badge-status ' + (isOn ? 'bg-success text-white' : 'bg-danger text-white');
    el.textContent = isOn ? (HostBerry.t?.('security.enabled', 'Enabled') || 'Enabled') : (HostBerry.t?.('security.disabled', 'Disabled') || 'Disabled');
  };

  const setText = (id, value) => {
    const el = document.getElementById(id);
    if(el){ el.textContent = value; }
  };

  async function fetchSecurityStatus(){
    try{
      const resp = await HostBerry.apiRequest('/api/v1/security/status');
      if(!resp.ok) throw new Error('Status request failed');
      const payload = await resp.json();
      const data = payload.data || payload;
      setBadge('status-audit', data.audit_logging_enabled);
      setBadge('status-rate', data.rate_limiting_enabled);
      setBadge('status-headers', data.security_headers_enabled);
      setBadge('status-backup', data.backup_encryption_enabled);
      setBadge('status-2fa', data.two_factor_enabled);
      setBadge('status-ip-lists', data.ip_blacklist_enabled || data.ip_whitelist_enabled);
      setText('security-last-check', new Date().toLocaleString());
      const pill = document.getElementById('security-overall-pill');
      if(pill){
        pill.className = 'status-pill bg-opacity-25 bg-success text-white mt-2';
        pill.textContent = HostBerry.t?.('security.status_ok', 'All systems nominal') || 'All systems nominal';
      }
    }catch(error){
      console.error('Security status failed', error);
      HostBerry.showAlert?.('danger', HostBerry.t?.('errors.security_status', 'Unable to fetch security status') || 'Unable to fetch security status');
    }
  }

  async function loadServices(){
    const container = document.getElementById('services-list');
    if(!container) return;
    try{
      const resp = await HostBerry.apiRequest('/api/v1/system/services');
      if(!resp.ok) throw new Error('Services request failed');
      const payload = await resp.json();
      const services = payload.services || {};
      
      if(!Object.keys(services).length){
        container.innerHTML = `
          <div class="text-center py-4 text-white-50">
            <i class="bi bi-journal-x"></i>
            <p class="mb-0 mt-2">${HostBerry.t?.('security.no_services', 'No services found') || 'No services found'}</p>
          </div>`;
        return;
      }
      
      container.innerHTML = '';
      Object.keys(services).forEach(serviceName => {
        const service = services[serviceName];
        const status = service.status || service;
        const statusLower = (typeof status === 'string' ? status : 'unknown').toLowerCase();
        const isRunning = statusLower === 'running' || statusLower === 'active';
        const statusText = isRunning 
          ? (HostBerry.t?.('system.running', 'Ejecut√°ndose') || 'Running')
          : (HostBerry.t?.('system.stopped', 'Detenido') || 'Stopped');
        const statusClass = isRunning ? 'bg-success' : 'bg-danger';
        
        const item = document.createElement('div');
        item.className = 'service-item';
        item.innerHTML = `
          <span class="service-name">${serviceName}</span>
          <span class="badge ${statusClass} text-white">${statusText}</span>
        `;
        container.appendChild(item);
      });
    }catch(error){
      console.error('Services load failed', error);
      container.innerHTML = `
        <div class="text-center py-4 text-danger">
          <i class="bi bi-exclamation-triangle"></i>
          <p class="mb-0 mt-2">${HostBerry.t?.('security.services_error', 'Unable to load services') || 'Unable to load services'}</p>
        </div>`;
    }
  }

  async function loadLogs(){
    const container = document.getElementById('security-logs');
    const level = document.getElementById('securityLogLevel')?.value || 'warning';
    if(!container) return;
    try{
      const params = new URLSearchParams({ limit: '20' });
      if(level !== 'all') params.set('level', level.toUpperCase());
      const resp = await HostBerry.apiRequest(`/api/v1/system/logs?${params.toString()}`);
      if(!resp.ok) throw new Error('logs failed');
      const payload = await resp.json();
      const logs = Array.isArray(payload.logs) ? payload.logs : (Array.isArray(payload) ? payload : []);
      if(!logs.length){
        container.innerHTML = `
          <div class="text-center py-4 text-white-50">
            <i class="bi bi-journal-x"></i>
            <p class="mb-0 mt-2">${HostBerry.t?.('security.logs_empty', 'No security logs found') || 'No security logs found'}</p>
          </div>`;
        return;
      }
      container.innerHTML = '';
      logs.forEach(log => {
        const item = document.createElement('div');
        const levelLabel = (log.level || log.log_level || 'INFO').toUpperCase();
        const ts = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : (log.created_at ? new Date(log.created_at).toLocaleTimeString() : '--:--:--');
        const message = log.message || log.log_message || log.content || '';
        item.className = 'log-item';
        item.innerHTML = `
          <span class="text-white-50 small">${ts}</span>
          <span class="badge bg-${getLevelColor(levelLabel)} log-level">${levelLabel}</span>
          <span class="text-white flex-grow-1">${message}</span>`;
        container.appendChild(item);
      });
    }catch(error){
      console.error('Security logs failed', error);
      container.innerHTML = `
        <div class="text-center py-4 text-danger">
          <i class="bi bi-exclamation-triangle"></i>
          <p class="mb-0 mt-2">${HostBerry.t?.('security.logs_error', 'Unable to load logs') || 'Unable to load logs'}</p>
        </div>`;
    }
  }

  function getLevelColor(level){
    switch(level){
      case 'ERROR': return 'danger';
      case 'WARNING': return 'warning text-dark';
      case 'INFO': return 'info';
      default: return 'secondary';
    }
  }

  async function createBackup(){
    try{
      const confirmMsg = HostBerry.t?.('security.backup_confirm', 'Are you sure you want to create a backup?') || 'Are you sure you want to create a backup?';
      if(!confirm(confirmMsg)) return;
      
      HostBerry.showAlert?.('info', HostBerry.t?.('security.backup_creating', 'Creating backup...') || 'Creating backup...');
      
      const resp = await HostBerry.apiRequest('/api/v1/security/backup?include_logs=true&include_uploads=true', { method: 'POST' });
      if(!resp.ok){
        const errorText = await resp.text();
        throw new Error(errorText || 'Backup failed');
      }
      const payload = await resp.json();
      const message = payload.message || payload.data?.message || HostBerry.t?.('security.backup_success', 'Backup created successfully') || 'Backup created successfully';
      HostBerry.showAlert?.('success', message);
      await loadBackups();
    }catch(error){
      console.error('Backup failed', error);
      const errorMsg = HostBerry.t?.('security.backup_error', 'Unable to create backup') || 'Unable to create backup';
      HostBerry.showAlert?.('danger', errorMsg);
    }
  }

  async function loadBackups(){
    const list = document.getElementById('security-backup-list');
    if(!list) return;
    try{
      const resp = await HostBerry.apiRequest('/api/v1/security/backups');
      if(!resp.ok) throw new Error('Backups request failed');
      const payload = await resp.json();
      const backups = payload.data?.backups || payload.backups || [];
      if(!backups.length){
        list.innerHTML = `
          <div class="text-center py-4 text-white-50">
            <i class="bi bi-archive"></i>
            <p class="mb-0 mt-2">${HostBerry.t?.('security.no_backups', 'No backups listed yet') || 'No backups listed yet'}</p>
          </div>`;
        return;
      }
      list.innerHTML = '';
      backups.slice(0, 10).forEach(backup => {
        const item = document.createElement('div');
        item.className = 'backup-item text-white';
        const name = backup.name || backup.filename || backup.path || backup;
        const size = backup.size ? formatBytes(backup.size) : '';
        const date = backup.created_at || backup.timestamp || backup.date || '';
        const formattedDate = date ? new Date(date).toLocaleString() : '';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <strong class="d-block">${name}</strong>
              <span class="text-white-50 small">${formattedDate}</span>
            </div>
            ${size ? `<span class="text-white-50 small ms-2">${size}</span>` : ''}
          </div>`;
        list.appendChild(item);
      });
    }catch(error){
      console.error('Backups load failed', error);
      list.innerHTML = `
        <div class="text-center py-4 text-danger">
          <i class="bi bi-exclamation-triangle"></i>
          <p class="mb-0 mt-2">${HostBerry.t?.('security.backups_error', 'Unable to load backups') || 'Unable to load backups'}</p>
        </div>`;
    }
  }

  function formatBytes(bytes){
    if(!bytes || bytes === 0) return '';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  async function validateInput(){
    try{
      const promptMsg = HostBerry.t?.('security.prompt_input', 'Enter input to validate') || 'Enter input to validate';
      const sample = prompt(promptMsg) || '';
      if(!sample) return;
      const resp = await HostBerry.apiRequest('/api/v1/security/validate-input', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sample)
      });
      if(!resp.ok) throw new Error('Validation failed');
      const payload = await resp.json();
      const valid = payload.data?.is_valid !== false;
      const msg = valid 
        ? (HostBerry.t?.('security.input_ok', 'Input considered safe') || 'Input considered safe')
        : (HostBerry.t?.('security.input_not_ok', 'Potentially unsafe input detected') || 'Potentially unsafe input detected');
      HostBerry.showAlert?.(valid ? 'success' : 'warning', msg);
    }catch(error){
      console.error('Input validation failed', error);
      HostBerry.showAlert?.('danger', HostBerry.t?.('security.input_error', 'Unable to validate input') || 'Unable to validate input');
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    fetchSecurityStatus();
    loadServices();
    loadLogs();
    loadBackups();
    
    document.getElementById('securityStatusRefresh')?.addEventListener('click', fetchSecurityStatus);
    document.getElementById('servicesRefresh')?.addEventListener('click', loadServices);
    document.getElementById('securityLogsRefresh')?.addEventListener('click', loadLogs);
    document.getElementById('securityLogLevel')?.addEventListener('change', loadLogs);
    document.getElementById('securityBackupsRefresh')?.addEventListener('click', loadBackups);
    document.getElementById('action-create-backup')?.addEventListener('click', createBackup);
    document.getElementById('action-list-backups')?.addEventListener('click', loadBackups);
    document.getElementById('action-validate-input')?.addEventListener('click', validateInput);
    
    setInterval(fetchSecurityStatus, 60000);
    setInterval(loadServices, 60000);
    setInterval(loadLogs, 20000);
    setInterval(loadBackups, 30000);
  });
})();
</script>
{% endblock %}
