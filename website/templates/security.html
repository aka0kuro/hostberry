{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-12 text-center">
                <h1 class="dashboard-title">
                    <i class="bi bi-shield-lock me-2"></i>
                    {{ t('navigation.security', 'Security') }}
                </h1>
                <p class="dashboard-subtitle">{{ t('security.subtitle', 'Monitor audit, rate limiting and backup posture in real time') }}</p>
                <div class="dashboard-time">
                    <i class="bi bi-clock me-1"></i>
                    {{ t('security.last_check', 'Last check') }}: <span id="security-last-check">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Status Cards -->
    <div class="row mb-4 status-cards-row">
        <div class="col-lg-3 col-md-6 col-12 mb-3">
            <div class="status-card">
                <div class="status-card-header">
                    <div class="status-icon" style="background: linear-gradient(135deg, #198754 0%, #0f5132 100%);">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="status-info">
                        <h6>{{ t('security.audit_logging', 'Audit logging') }}</h6>
                    </div>
                </div>
                <div class="status-footer">
                    <span class="status-text" id="status-audit-badge">
                        <span class="badge bg-secondary">--</span>
                    </span>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 col-12 mb-3">
            <div class="status-card">
                <div class="status-card-header">
                    <div class="status-icon" style="background: linear-gradient(135deg, #0dcaf0 0%, #055160 100%);">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                    <div class="status-info">
                        <h6>{{ t('security.rate_limit', 'Rate limiting') }}</h6>
                    </div>
                </div>
                <div class="status-footer">
                    <span class="status-text" id="status-rate-badge">
                        <span class="badge bg-secondary">--</span>
                    </span>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 col-12 mb-3">
            <div class="status-card">
                <div class="status-card-header">
                    <div class="status-icon" style="background: linear-gradient(135deg, #ffc107 0%, #856404 100%);">
                        <i class="bi bi-shield-fill"></i>
                    </div>
                    <div class="status-info">
                        <h6>{{ t('security.security_headers', 'Security headers') }}</h6>
                    </div>
                </div>
                <div class="status-footer">
                    <span class="status-text" id="status-headers-badge">
                        <span class="badge bg-secondary">--</span>
                    </span>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 col-12 mb-3">
            <div class="status-card">
                <div class="status-card-header">
                    <div class="status-icon" style="background: linear-gradient(135deg, #6610f2 0%, #3d0a91 100%);">
                        <i class="bi bi-hdd-network"></i>
                    </div>
                    <div class="status-info">
                        <h6>{{ t('security.backup_encryption', 'Backup encryption') }}</h6>
                    </div>
                </div>
                <div class="status-footer">
                    <span class="status-text" id="status-backup-badge">
                        <span class="badge bg-secondary">--</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Security Controls -->
    <div class="row mb-4 status-cards-row">
        <div class="col-lg-6 col-md-6 col-12 mb-3">
            <div class="status-card">
                <div class="status-card-header">
                    <div class="status-icon" style="background: linear-gradient(135deg, #dc3545 0%, #8b0000 100%);">
                        <i class="bi bi-shield-lock-fill"></i>
                    </div>
                    <div class="status-info">
                        <h6>{{ t('security.two_factor', 'Two-factor auth') }}</h6>
                    </div>
                </div>
                <div class="status-footer">
                    <span class="status-text" id="status-2fa-badge">
                        <span class="badge bg-secondary">--</span>
                    </span>
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-6 col-12 mb-3">
            <div class="status-card">
                <div class="status-card-header">
                    <div class="status-icon" style="background: linear-gradient(135deg, #fd7e14 0%, #a04a00 100%);">
                        <i class="bi bi-list-check"></i>
                    </div>
                    <div class="status-info">
                        <h6>{{ t('security.ip_lists', 'IP blacklist / whitelist') }}</h6>
                    </div>
                </div>
                <div class="status-footer">
                    <span class="status-text" id="status-ip-lists-badge">
                        <span class="badge bg-secondary">--</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="actions-card">
                <div class="actions-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="actions-card-title">
                            <i class="bi bi-lightning-charge me-2"></i>
                            {{ t('security.actions_heading', 'Quick actions') }}
                        </h5>
                        <button class="btn btn-sm btn-outline-light" id="securityStatusRefresh">
                            <i class="bi bi-arrow-clockwise me-1"></i>{{ t('common.refresh', 'Refresh') }}
                        </button>
                    </div>
                </div>
                <div class="actions-card-body">
                    <div class="row g-3">
                        <div class="col-lg-4 col-md-6 col-12">
                            <button class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2 p-3 action-btn" id="action-create-backup" style="border-radius: 16px; transition: all 0.3s ease;">
                                <div class="action-icon" style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-hdd-network" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="text-start flex-grow-1">
                                    <div class="fw-bold">{{ t('security.create_backup', 'Create encrypted backup') }}</div>
                                    <small class="opacity-75">{{ t('security.create_backup_desc', 'Create a secure system backup') }}</small>
                                </div>
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                        <div class="col-lg-4 col-md-6 col-12">
                            <button class="btn btn-outline-light w-100 d-flex align-items-center justify-content-center gap-2 p-3 action-btn" id="action-list-backups" style="border-radius: 16px; transition: all 0.3s ease;">
                                <div class="action-icon" style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-archive" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="text-start flex-grow-1">
                                    <div class="fw-bold">{{ t('security.list_backups', 'List backups') }}</div>
                                    <small class="opacity-75">{{ t('security.list_backups_desc', 'View all available backups') }}</small>
                                </div>
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                        <div class="col-lg-4 col-md-6 col-12">
                            <button class="btn btn-outline-light w-100 d-flex align-items-center justify-content-center gap-2 p-3 action-btn" id="action-validate-input" style="border-radius: 16px; transition: all 0.3s ease;">
                                <div class="action-icon" style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-shield-check" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="text-start flex-grow-1">
                                    <div class="fw-bold">{{ t('security.validate_input', 'Validate input sanitization') }}</div>
                                    <small class="opacity-75">{{ t('security.validate_input_desc', 'Test input validation') }}</small>
                                </div>
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Services, Logs & Backups -->
    <div class="row services-network-row">
        <!-- Active Services -->
        <div class="col-lg-4 mb-4">
            <div class="services-card">
                <div class="services-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="services-card-title">
                            <i class="bi bi-server me-2"></i>
                            {{ t('security.active_services', 'Active Services') }}
                        </h5>
                        <button class="btn btn-sm btn-outline-light" id="servicesRefresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="services-card-body">
                    <div id="services-list">
                        <div class="text-center py-4 text-white-50">
                            <i class="bi bi-arrow-clockwise spinning"></i>
                            <p class="mb-0 mt-2">{{ t('security.loading_services', 'Loading services...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Logs -->
        <div class="col-lg-4 mb-4">
            <div class="logs-card">
                <div class="logs-card-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="logs-card-title">
                                <i class="bi bi-journal-text me-2"></i>
                                {{ t('security.logs_heading', 'Security logs') }}
                            </h5>
                            <p class="text-white-50 mb-0 small">{{ t('security.logs_caption', 'Filter critical events in real time') }}</p>
                        </div>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm bg-dark text-white border-secondary" id="securityLogLevel">
                                <option value="warning">{{ t('security.logs_warnings', 'Warnings') }}</option>
                                <option value="error">{{ t('security.logs_errors', 'Errors') }}</option>
                                <option value="info">{{ t('security.logs_info', 'Info') }}</option>
                                <option value="all">{{ t('security.logs_all', 'All') }}</option>
                            </select>
                            <button class="btn btn-sm btn-outline-light" id="securityLogsRefresh">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="logs-card-body">
                    <div class="logs-container" id="security-logs">
                        <div class="text-center py-4 text-white-50">
                            <i class="bi bi-arrow-clockwise spinning"></i>
                            <p class="mb-0 mt-2">{{ t('security.loading_logs', 'Loading logs...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup Inventory -->
        <div class="col-lg-4 mb-4">
            <div class="network-card">
                <div class="network-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="network-card-title">
                                <i class="bi bi-archive me-2"></i>
                                {{ t('security.backups_heading', 'Backup inventory') }}
                            </h5>
                            <p class="text-white-50 mb-0 small">{{ t('security.backups_caption', 'Latest encrypted backups stored on device') }}</p>
                        </div>
                        <button class="btn btn-sm btn-outline-light" id="securityBackupsRefresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="network-card-body">
                    <div class="backup-list" id="security-backup-list">
                        <div class="text-center py-4 text-white-50">
                            <i class="bi bi-database"></i>
                            <p class="mb-0 mt-2">{{ t('security.no_backups', 'No backups listed yet') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const setBadge = (id, enabled) => {
    const el = document.getElementById(id);
    if(!el) return;
    const isOn = !!enabled;
    const enabledText = HostBerry.t?.('security.enabled', 'Enabled') || 'Enabled';
    const disabledText = HostBerry.t?.('security.disabled', 'Disabled') || 'Disabled';
    el.className = 'badge ' + (isOn ? 'bg-success' : 'bg-danger');
    el.textContent = isOn ? enabledText : disabledText;
  };

  const setStatusCard = (idPrefix, enabled) => {
    const badgeEl = document.getElementById(idPrefix + '-badge');
    if(badgeEl) {
      const badge = badgeEl.querySelector('.badge');
      if(badge) {
        badge.className = 'badge ' + (enabled ? 'bg-success' : 'bg-danger');
        badge.textContent = enabled 
          ? (HostBerry.t?.('security.enabled', 'Enabled') || 'Enabled')
          : (HostBerry.t?.('security.disabled', 'Disabled') || 'Disabled');
      }
    }
  };

  const setText = (id, value) => {
    const el = document.getElementById(id);
    if(el){ el.textContent = value; }
  };

  async function fetchSecurityStatus(){
    try{
      const resp = await HostBerry.apiRequest('/api/v1/security/status');
      if(!resp.ok) throw new Error('Status request failed');
      const payload = await resp.json();
      const data = payload.data || payload;
      
      setStatusCard('status-audit', data.audit_logging_enabled);
      setStatusCard('status-rate', data.rate_limiting_enabled);
      setStatusCard('status-headers', data.security_headers_enabled);
      setStatusCard('status-backup', data.backup_encryption_enabled);
      setStatusCard('status-2fa', data.two_factor_enabled);
      setStatusCard('status-ip-lists', data.ip_blacklist_enabled || data.ip_whitelist_enabled);
      setText('security-last-check', new Date().toLocaleString());
    }catch(error){
      console.error('Security status failed', error);
      HostBerry.showAlert?.('danger', HostBerry.t?.('errors.security_status', 'Unable to fetch security status') || 'Unable to fetch security status');
    }
  }

  async function loadServices(){
    const container = document.getElementById('services-list');
    if(!container) return;
    try{
      const resp = await HostBerry.apiRequest('/api/v1/system/services');
      if(!resp.ok) throw new Error('Services request failed');
      const payload = await resp.json();
      const services = payload.services || {};
      
      if(!Object.keys(services).length){
        container.innerHTML = `
          <div class="text-center py-4 text-white-50">
            <i class="bi bi-journal-x"></i>
            <p class="mb-0 mt-2">${HostBerry.t?.('security.no_services', 'No services found') || 'No services found'}</p>
          </div>`;
        return;
      }
      
      container.innerHTML = '';
      const serviceIcons = {
        'hostberry': 'bi-gear-fill hostberry-icon',
        'nginx': 'bi-shield-check nginx-icon',
        'fail2ban': 'bi-shield-fill fail2ban-icon',
        'ufw': 'bi-shield-lock ufw-icon',
        'ssh': 'bi-terminal ssh-icon',
        'hostapd': 'bi-wifi wifi-icon',
        'openvpn': 'bi-shield-check openvpn-icon',
        'wg-quick': 'bi-shield-lock wireguard-icon',
        'wireguard': 'bi-shield-lock wireguard-icon',
        'dnsmasq': 'bi-diagram-3 dns-icon',
        'adblock': 'bi-shield-x adblock-icon'
      };
      
      Object.keys(services).forEach(serviceName => {
        const service = services[serviceName];
        const status = service.status || service;
        const statusLower = (typeof status === 'string' ? status : 'unknown').toLowerCase();
        const isRunning = statusLower === 'running' || statusLower === 'active';
        const statusText = isRunning 
          ? (HostBerry.t?.('system.running', 'Running') || 'Running')
          : (HostBerry.t?.('system.stopped', 'Stopped') || 'Stopped');
        const statusClass = isRunning ? 'bg-success' : 'bg-danger';
        
        const normalizedName = serviceName.toLowerCase().replace(/[_-]/g, '');
        const iconClass = serviceIcons[normalizedName] || serviceIcons[serviceName.toLowerCase()] || 'bi-gear-fill default-icon';
        
        const item = document.createElement('div');
        item.className = 'service-item';
        item.innerHTML = `
          <div class="service-info">
            <i class="bi ${iconClass} service-icon"></i>
            <span class="service-name">${serviceName}</span>
          </div>
          <div class="service-status">
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
        `;
        container.appendChild(item);
      });
    }catch(error){
      console.error('Services load failed', error);
      container.innerHTML = `
        <div class="text-center py-4 text-danger">
          <i class="bi bi-exclamation-triangle"></i>
          <p class="mb-0 mt-2">${HostBerry.t?.('security.services_error', 'Unable to load services') || 'Unable to load services'}</p>
        </div>`;
    }
  }

  async function loadLogs(){
    const container = document.getElementById('security-logs');
    const level = document.getElementById('securityLogLevel')?.value || 'warning';
    if(!container) return;
    try{
      const params = new URLSearchParams({ limit: '20' });
      if(level !== 'all') params.set('level', level.toUpperCase());
      const resp = await HostBerry.apiRequest(`/api/v1/system/logs?${params.toString()}`);
      if(!resp.ok) throw new Error('logs failed');
      const payload = await resp.json();
      const logs = Array.isArray(payload.logs) ? payload.logs : (Array.isArray(payload) ? payload : []);
      if(!logs.length){
        container.innerHTML = `
          <div class="text-center py-4 text-white-50">
            <i class="bi bi-journal-x"></i>
            <p class="mb-0 mt-2">${HostBerry.t?.('security.logs_empty', 'No security logs found') || 'No security logs found'}</p>
          </div>`;
        return;
      }
      container.innerHTML = '';
      logs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'log-item';
        const levelLabel = (log.level || log.log_level || 'INFO').toUpperCase();
        const ts = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : (log.created_at ? new Date(log.created_at).toLocaleTimeString() : '--:--:--');
        const message = log.message || log.log_message || log.content || '';
        item.innerHTML = `
          <span class="text-white-50 small">${ts}</span>
          <span class="badge bg-${getLevelColor(levelLabel)} log-level">${levelLabel}</span>
          <span class="text-white flex-grow-1">${message}</span>`;
        container.appendChild(item);
      });
    }catch(error){
      console.error('Security logs failed', error);
      container.innerHTML = `
        <div class="text-center py-4 text-danger">
          <i class="bi bi-exclamation-triangle"></i>
          <p class="mb-0 mt-2">${HostBerry.t?.('security.logs_error', 'Unable to load logs') || 'Unable to load logs'}</p>
        </div>`;
    }
  }

  function getLevelColor(level){
    switch(level){
      case 'ERROR': return 'danger';
      case 'WARNING': return 'warning text-dark';
      case 'INFO': return 'info';
      default: return 'secondary';
    }
  }

  async function createBackup(){
    try{
      const confirmMsg = HostBerry.t?.('security.backup_confirm', 'Are you sure you want to create a backup?') || 'Are you sure you want to create a backup?';
      if(!confirm(confirmMsg)) return;
      
      HostBerry.showAlert?.('info', HostBerry.t?.('security.backup_creating', 'Creating backup...') || 'Creating backup...');
      
      const resp = await HostBerry.apiRequest('/api/v1/security/backup?include_logs=true&include_uploads=true', { method: 'POST' });
      if(!resp.ok){
        const errorText = await resp.text();
        throw new Error(errorText || 'Backup failed');
      }
      const payload = await resp.json();
      const message = payload.message || payload.data?.message || HostBerry.t?.('security.backup_success', 'Backup created successfully') || 'Backup created successfully';
      HostBerry.showAlert?.('success', message);
      await loadBackups();
    }catch(error){
      console.error('Backup failed', error);
      const errorMsg = HostBerry.t?.('security.backup_error', 'Unable to create backup') || 'Unable to create backup';
      HostBerry.showAlert?.('danger', errorMsg);
    }
  }

  async function loadBackups(){
    const list = document.getElementById('security-backup-list');
    if(!list) return;
    try{
      const resp = await HostBerry.apiRequest('/api/v1/security/backups');
      if(!resp.ok) throw new Error('Backups request failed');
      const payload = await resp.json();
      const backups = payload.data?.backups || payload.backups || [];
      if(!backups.length){
        list.innerHTML = `
          <div class="text-center py-4 text-white-50">
            <i class="bi bi-archive"></i>
            <p class="mb-0 mt-2">${HostBerry.t?.('security.no_backups', 'No backups listed yet') || 'No backups listed yet'}</p>
          </div>`;
        return;
      }
      list.innerHTML = '';
      backups.slice(0, 10).forEach(backup => {
        const item = document.createElement('div');
        item.className = 'backup-item text-white';
        const name = backup.name || backup.filename || backup.path || (typeof backup === 'string' ? backup : 'backup');
        const size = backup.size ? formatBytes(backup.size) : '';
        const date = backup.created_at || backup.timestamp || backup.date || backup.created || '';
        const formattedDate = date ? new Date(date).toLocaleString() : '';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-center gap-2">
            <div class="flex-grow-1 min-w-0">
              <strong class="d-block backup-name" title="${name}">${name}</strong>
              <span class="text-white-50 small">${formattedDate}</span>
            </div>
            <div class="d-flex align-items-center gap-2 flex-shrink-0">
              ${size ? `<span class="text-white-50 small">${size}</span>` : ''}
              <button class="btn btn-sm btn-outline-primary download-backup-btn" data-backup-name="${name}" title="${HostBerry.t?.('security.download_backup', 'Download') || 'Download'}">
                <i class="bi bi-download"></i>
              </button>
              <button class="btn btn-sm btn-outline-warning restore-backup-btn" data-backup-name="${name}" title="${HostBerry.t?.('security.restore_backup', 'Restore') || 'Restore'}">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>`;
        list.appendChild(item);
      });
      
      // Agregar event listeners a los botones
      document.querySelectorAll('.download-backup-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const backupName = btn.getAttribute('data-backup-name');
          downloadBackup(backupName);
        });
      });
      
      document.querySelectorAll('.restore-backup-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const backupName = btn.getAttribute('data-backup-name');
          restoreBackup(backupName);
        });
      });
    }catch(error){
      console.error('Backups load failed', error);
      list.innerHTML = `
        <div class="text-center py-4 text-danger">
          <i class="bi bi-exclamation-triangle"></i>
          <p class="mb-0 mt-2">${HostBerry.t?.('security.backups_error', 'Unable to load backups') || 'Unable to load backups'}</p>
        </div>`;
    }
  }

  function formatBytes(bytes){
    if(!bytes || bytes === 0) return '';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  async function validateInput(){
    try{
      const promptMsg = HostBerry.t?.('security.prompt_input', 'Enter input to validate') || 'Enter input to validate';
      const sample = prompt(promptMsg) || '';
      if(!sample) return;
      const resp = await HostBerry.apiRequest('/api/v1/security/validate-input', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sample)
      });
      if(!resp.ok) throw new Error('Validation failed');
      const payload = await resp.json();
      const valid = payload.data?.is_valid !== false;
      const msg = valid 
        ? (HostBerry.t?.('security.input_ok', 'Input considered safe') || 'Input considered safe')
        : (HostBerry.t?.('security.input_not_ok', 'Potentially unsafe input detected') || 'Potentially unsafe input detected');
      HostBerry.showAlert?.(valid ? 'success' : 'warning', msg);
    }catch(error){
      console.error('Input validation failed', error);
      HostBerry.showAlert?.('danger', HostBerry.t?.('security.input_error', 'Unable to validate input') || 'Unable to validate input');
    }
  }

  async function downloadBackup(backupName){
    try{
      if(!backupName){
        HostBerry.showAlert?.('danger', HostBerry.t?.('errors.backup_not_found', 'Backup not found') || 'Backup not found');
        return;
      }
      
      HostBerry.showAlert?.('info', HostBerry.t?.('security.backup_downloaded', 'Downloading backup...') || 'Downloading backup...');
      
      // Crear enlace de descarga
      const downloadUrl = `/api/v1/security/backup/${encodeURIComponent(backupName)}/download`;
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = backupName;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Esperar un momento y mostrar mensaje de éxito
      setTimeout(() => {
        HostBerry.showAlert?.('success', HostBerry.t?.('security.backup_downloaded', 'Backup downloaded successfully') || 'Backup downloaded successfully');
      }, 500);
      
    }catch(error){
      console.error('Backup download failed', error);
      HostBerry.showAlert?.('danger', HostBerry.t?.('security.backup_download_error', 'Unable to download backup') || 'Unable to download backup');
    }
  }

  async function restoreBackup(backupName){
    try{
      if(!backupName){
        HostBerry.showAlert?.('danger', HostBerry.t?.('errors.backup_not_found', 'Backup not found') || 'Backup not found');
        return;
      }
      
      // Confirmación doble para restauración
      const confirmMsg1 = HostBerry.t?.('security.backup_restore_confirm', 'Are you sure you want to restore this backup? This will replace the current system data.') || 'Are you sure you want to restore this backup? This will replace the current system data.';
      if(!confirm(confirmMsg1)) return;
      
      const confirmMsg2 = HostBerry.t?.('security.backup_restore_confirm_final', 'WARNING! This action will restore the backup and replace current data. Are you absolutely sure?') || 'WARNING! This action will restore the backup and replace current data. Are you absolutely sure?';
      if(!confirm(confirmMsg2)) return;
      
      HostBerry.showAlert?.('warning', HostBerry.t?.('security.backup_restoring', 'Restoring backup...') || 'Restoring backup...');
      
      const resp = await HostBerry.apiRequest(`/api/v1/security/backup/${encodeURIComponent(backupName)}/restore`, {
        method: 'POST'
      });
      
      if(!resp.ok){
        const errorText = await resp.text();
        throw new Error(errorText || 'Restore failed');
      }
      
      const payload = await resp.json();
      const message = payload.message || payload.data?.message || HostBerry.t?.('security.backup_restored', 'Backup restored successfully') || 'Backup restored successfully';
      HostBerry.showAlert?.('success', message);
      
      // Recargar la lista de backups después de un momento
      setTimeout(() => {
        loadBackups();
      }, 2000);
      
    }catch(error){
      console.error('Backup restore failed', error);
      const errorMsg = HostBerry.t?.('security.backup_restore_error', 'Unable to restore backup') || 'Unable to restore backup';
      HostBerry.showAlert?.('danger', errorMsg);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    fetchSecurityStatus();
    loadServices();
    loadLogs();
    loadBackups();
    
    document.getElementById('securityStatusRefresh')?.addEventListener('click', fetchSecurityStatus);
    document.getElementById('servicesRefresh')?.addEventListener('click', loadServices);
    document.getElementById('securityLogsRefresh')?.addEventListener('click', loadLogs);
    document.getElementById('securityLogLevel')?.addEventListener('change', loadLogs);
    document.getElementById('securityBackupsRefresh')?.addEventListener('click', loadBackups);
    document.getElementById('action-create-backup')?.addEventListener('click', createBackup);
    document.getElementById('action-list-backups')?.addEventListener('click', loadBackups);
    document.getElementById('action-validate-input')?.addEventListener('click', validateInput);
    
    setInterval(fetchSecurityStatus, 60000);
    setInterval(loadServices, 60000);
    setInterval(loadLogs, 20000);
    setInterval(loadBackups, 30000);
  });
})();
</script>
<style>
.spinning {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.log-item {
    padding: 0.75rem 1rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 0.75rem;
}
.log-item:last-child {
    margin-bottom: 0;
}
.log-level {
    min-width: 80px;
    text-transform: uppercase;
    font-size: 0.7rem;
}
.backup-item {
    padding: 0.75rem 1rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}
.backup-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}
.backup-item:last-child {
    margin-bottom: 0;
}
.backup-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
    word-break: break-all;
}
.backup-item .min-w-0 {
    min-width: 0;
}
.backup-item .flex-shrink-0 {
    flex-shrink: 0;
}
.logs-container {
    max-height: 380px;
    overflow-y: auto;
}
.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}
.action-btn .action-icon {
    transition: all 0.3s ease;
}
.action-btn:hover .action-icon {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.3) !important;
}
</style>
{% endblock %}
