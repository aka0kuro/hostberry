{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-12 text-center">
                <h1 class="dashboard-title">
                    <i class="bi bi-hdd-network me-2"></i>
                    {{ t('navigation.backup', 'Backup') }}
                </h1>
                <p class="dashboard-subtitle">{{ t('backup.subtitle', 'Gestiona y restaura tus respaldos del sistema') }}</p>
                <div class="dashboard-time">
                    <i class="bi bi-clock me-1"></i>
                    {{ t('backup.last_check', 'Última verificación') }}: <span id="backup-last-check">--</span>
                </div>
            </div>
        </div>
    </div>



    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="actions-card">
                <div class="actions-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="actions-card-title">
                            <i class="bi bi-lightning-charge me-2"></i>
                            {{ t('backup.actions_heading', 'Acciones de backup') }}
                        </h5>
                        <button class="btn btn-sm btn-outline-light" id="backupsRefresh">
                            <i class="bi bi-arrow-clockwise me-1"></i>{{ t('common.refresh', 'Refresh') }}
                        </button>
                    </div>
                </div>
                <div class="actions-card-body">
                    <div class="row g-3">
                        <div class="col-lg-4 col-md-6 col-12">
                            <button class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2 p-3 action-btn" id="action-create-backup" style="border-radius: 16px; transition: all 0.3s ease;">
                                <div class="action-icon" style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-hdd-network" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="text-start flex-grow-1">
                                    <div class="fw-bold">{{ t('backup.create_backup', 'Crear backup') }}</div>
                                    <small class="opacity-75">{{ t('backup.create_backup_desc', 'Crear un respaldo del sistema') }}</small>
                                </div>
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                        <div class="col-lg-4 col-md-6 col-12">
                            <label class="btn btn-outline-light w-100 d-flex align-items-center justify-content-center gap-2 p-3 action-btn" id="action-upload-backup" style="border-radius: 16px; transition: all 0.3s ease; cursor: pointer; margin: 0;">
                                <input type="file" id="backup-file-input" accept=".tar.gz,.tgz" style="display: none;">
                                <div class="action-icon" style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-cloud-upload" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="text-start flex-grow-1">
                                    <div class="fw-bold">{{ t('backup.upload_backup', 'Cargar backup') }}</div>
                                    <small class="opacity-75">{{ t('backup.upload_backup_desc', 'Subir un archivo de backup') }}</small>
                                </div>
                                <i class="bi bi-arrow-right"></i>
                            </label>
                        </div>
                        <div class="col-lg-4 col-md-6 col-12">
                            <button class="btn btn-outline-light w-100 d-flex align-items-center justify-content-center gap-2 p-3 action-btn" id="action-list-backups" style="border-radius: 16px; transition: all 0.3s ease;">
                                <div class="action-icon" style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-archive" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="text-start flex-grow-1">
                                    <div class="fw-bold">{{ t('backup.list_backups', 'Listar backups') }}</div>
                                    <small class="opacity-75">{{ t('backup.list_backups_desc', 'Ver todos los backups disponibles') }}</small>
                                </div>
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Inventory -->
    <div class="row services-network-row">
        <!-- Backup Inventory -->
        <div class="col-lg-12 mb-4">
            <div class="network-card">
                <div class="network-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="network-card-title">
                                <i class="bi bi-archive me-2"></i>
                                {{ t('security.backups_heading', 'Backup inventory') }}
                            </h5>
                            <p class="text-white-50 mb-0 small">{{ t('security.backups_caption', 'Latest encrypted backups stored on device') }}</p>
                        </div>
                        <button class="btn btn-sm btn-outline-light" id="securityBackupsRefresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="network-card-body">
                    <div class="backup-list" id="security-backup-list">
                        <div class="text-center py-4 text-white-50">
                            <i class="bi bi-database"></i>
                            <p class="mb-0 mt-2">{{ t('security.no_backups', 'No backups listed yet') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const setBadge = (id, enabled) => {
    const el = document.getElementById(id);
    if(!el) return;
    const isOn = !!enabled;
    const enabledText = HostBerry.t?.('security.enabled', 'Enabled') || 'Enabled';
    const disabledText = HostBerry.t?.('security.disabled', 'Disabled') || 'Disabled';
    el.className = 'badge ' + (isOn ? 'bg-success' : 'bg-danger');
    el.textContent = isOn ? enabledText : disabledText;
  };

  const setStatusCard = (idPrefix, enabled) => {
    const badgeEl = document.getElementById(idPrefix + '-badge');
    if(badgeEl) {
      const badge = badgeEl.querySelector('.badge');
      if(badge) {
        badge.className = 'badge ' + (enabled ? 'bg-success' : 'bg-danger');
        badge.textContent = enabled 
          ? (HostBerry.t?.('security.enabled', 'Enabled') || 'Enabled')
          : (HostBerry.t?.('security.disabled', 'Disabled') || 'Disabled');
      }
    }
  };

  const setText = (id, value) => {
    const el = document.getElementById(id);
    if(el){ el.textContent = value; }
  };

  async function updateLastCheck(){
    setText('backup-last-check', new Date().toLocaleString());
  }


  async function createBackup(){
    try{
      const confirmMsg = HostBerry.t?.('security.backup_confirm', 'Are you sure you want to create a backup?') || 'Are you sure you want to create a backup?';
      if(!confirm(confirmMsg)) return;
      
      HostBerry.showAlert?.('info', HostBerry.t?.('security.backup_creating', 'Creating backup...') || 'Creating backup...');
      
      const resp = await HostBerry.apiRequest('/api/v1/security/backup?include_logs=true&include_uploads=true', { method: 'POST' });
      if(!resp.ok){
        const errorText = await resp.text();
        throw new Error(errorText || 'Backup failed');
      }
      const payload = await resp.json();
      const message = payload.message || payload.data?.message || HostBerry.t?.('security.backup_success', 'Backup created successfully') || 'Backup created successfully';
      HostBerry.showAlert?.('success', message);
      await loadBackups();
    }catch(error){
      console.error('Backup failed', error);
      const errorMsg = HostBerry.t?.('security.backup_error', 'Unable to create backup') || 'Unable to create backup';
      HostBerry.showAlert?.('danger', errorMsg);
    }
  }

  async function loadBackups(){
    const list = document.getElementById('security-backup-list');
    if(!list) return;
    try{
      const resp = await HostBerry.apiRequest('/api/v1/security/backups');
      if(!resp.ok) throw new Error('Backups request failed');
      const payload = await resp.json();
      const backups = payload.data?.backups || payload.backups || [];
      if(!backups.length){
        list.innerHTML = `
          <div class="text-center py-4 text-white-50">
            <i class="bi bi-archive"></i>
            <p class="mb-0 mt-2">${HostBerry.t?.('security.no_backups', 'No backups listed yet') || 'No backups listed yet'}</p>
          </div>`;
        return;
      }
      list.innerHTML = '';
      backups.slice(0, 10).forEach(backup => {
        const item = document.createElement('div');
        item.className = 'backup-item text-white';
        const name = backup.name || backup.filename || backup.path || (typeof backup === 'string' ? backup : 'backup');
        const size = backup.size ? formatBytes(backup.size) : '';
        const date = backup.created_at || backup.timestamp || backup.date || backup.created || '';
        const formattedDate = date ? new Date(date).toLocaleString() : '';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-center gap-2">
            <div class="flex-grow-1 min-w-0">
              <strong class="d-block backup-name" title="${name}">${name}</strong>
              <span class="text-white-50 small">${formattedDate}</span>
            </div>
            <div class="d-flex align-items-center gap-2 flex-shrink-0">
              ${size ? `<span class="text-white-50 small">${size}</span>` : ''}
              <button class="btn btn-sm btn-outline-primary download-backup-btn" data-backup-name="${name}" title="${HostBerry.t?.('security.download_backup', 'Download') || 'Download'}">
                <i class="bi bi-download"></i>
              </button>
              <button class="btn btn-sm btn-outline-warning restore-backup-btn" data-backup-name="${name}" title="${HostBerry.t?.('security.restore_backup', 'Restore') || 'Restore'}">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>`;
        list.appendChild(item);
      });
      
      // Agregar event listeners a los botones
      document.querySelectorAll('.download-backup-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const backupName = btn.getAttribute('data-backup-name');
          downloadBackup(backupName);
        });
      });
      
      document.querySelectorAll('.restore-backup-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const backupName = btn.getAttribute('data-backup-name');
          restoreBackup(backupName);
        });
      });
    }catch(error){
      console.error('Backups load failed', error);
      list.innerHTML = `
        <div class="text-center py-4 text-danger">
          <i class="bi bi-exclamation-triangle"></i>
          <p class="mb-0 mt-2">${HostBerry.t?.('security.backups_error', 'Unable to load backups') || 'Unable to load backups'}</p>
        </div>`;
    }
  }

  function formatBytes(bytes){
    if(!bytes || bytes === 0) return '';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }


  async function downloadBackup(backupName){
    try{
      if(!backupName){
        HostBerry.showAlert?.('danger', HostBerry.t?.('errors.backup_not_found', 'Backup not found') || 'Backup not found');
        return;
      }
      
      HostBerry.showAlert?.('info', HostBerry.t?.('security.backup_downloaded', 'Downloading backup...') || 'Downloading backup...');
      
      // Crear enlace de descarga
      const downloadUrl = `/api/v1/security/backup/${encodeURIComponent(backupName)}/download`;
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = backupName;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Esperar un momento y mostrar mensaje de éxito
      setTimeout(() => {
        HostBerry.showAlert?.('success', HostBerry.t?.('security.backup_downloaded', 'Backup downloaded successfully') || 'Backup downloaded successfully');
      }, 500);
      
    }catch(error){
      console.error('Backup download failed', error);
      HostBerry.showAlert?.('danger', HostBerry.t?.('security.backup_download_error', 'Unable to download backup') || 'Unable to download backup');
    }
  }

  async function restoreBackup(backupName){
    try{
      if(!backupName){
        HostBerry.showAlert?.('danger', HostBerry.t?.('errors.backup_not_found', 'Backup not found') || 'Backup not found');
        return;
      }
      
      // Confirmación doble para restauración
      const confirmMsg1 = HostBerry.t?.('security.backup_restore_confirm', 'Are you sure you want to restore this backup? This will replace the current system data.') || 'Are you sure you want to restore this backup? This will replace the current system data.';
      if(!confirm(confirmMsg1)) return;
      
      const confirmMsg2 = HostBerry.t?.('security.backup_restore_confirm_final', 'WARNING! This action will restore the backup and replace current data. Are you absolutely sure?') || 'WARNING! This action will restore the backup and replace current data. Are you absolutely sure?';
      if(!confirm(confirmMsg2)) return;
      
      HostBerry.showAlert?.('warning', HostBerry.t?.('security.backup_restoring', 'Restoring backup...') || 'Restoring backup...');
      
      const resp = await HostBerry.apiRequest(`/api/v1/security/backup/${encodeURIComponent(backupName)}/restore`, {
        method: 'POST'
      });
      
      if(!resp.ok){
        const errorText = await resp.text();
        throw new Error(errorText || 'Restore failed');
      }
      
      const payload = await resp.json();
      const message = payload.message || payload.data?.message || HostBerry.t?.('security.backup_restored', 'Backup restored successfully') || 'Backup restored successfully';
      HostBerry.showAlert?.('success', message);
      
      // Recargar la lista de backups después de un momento
      setTimeout(() => {
        loadBackups();
      }, 2000);
      
    }catch(error){
      console.error('Backup restore failed', error);
      const errorMsg = HostBerry.t?.('security.backup_restore_error', 'Unable to restore backup') || 'Unable to restore backup';
      HostBerry.showAlert?.('danger', errorMsg);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    fetchSecurityStatus();
    loadBackups();
    
    document.getElementById('securityStatusRefresh')?.addEventListener('click', fetchSecurityStatus);
    document.getElementById('securityBackupsRefresh')?.addEventListener('click', loadBackups);
    document.getElementById('action-create-backup')?.addEventListener('click', createBackup);
    document.getElementById('action-list-backups')?.addEventListener('click', loadBackups);
    
    setInterval(fetchSecurityStatus, 60000);
    setInterval(loadBackups, 30000);
  });
})();
</script>
<style>
.spinning {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.log-item {
    padding: 0.75rem 1rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 0.75rem;
}
.log-item:last-child {
    margin-bottom: 0;
}
.log-level {
    min-width: 80px;
    text-transform: uppercase;
    font-size: 0.7rem;
}
.backup-item {
    padding: 0.75rem 1rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}
.backup-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}
.backup-item:last-child {
    margin-bottom: 0;
}
.backup-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
    word-break: break-all;
}
.backup-item .min-w-0 {
    min-width: 0;
}
.backup-item .flex-shrink-0 {
    flex-shrink: 0;
}
.logs-container {
    max-height: 380px;
    overflow-y: auto;
}
.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}
.action-btn .action-icon {
    transition: all 0.3s ease;
}
.action-btn:hover .action-icon {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.3) !important;
}
</style>
{% endblock %}
