{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block content %}
<div class="system-page">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <img src="/static/hostberry.png" alt="hostberry" class="logo-image" style="height: 24px; width: auto;" />
            <h1>HostBerry</h1>
            <p>{{ t('network.title', 'Network Management') }}</p>
        </div>
    </div>

    <div class="row">
        <!-- Network Interfaces -->
        <div class="col-xl-8 col-lg-7 mb-4">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-4 px-4">
                    <h5 class="card-title mb-0 fw-bold text-white">
                        <i class="bi bi-hdd-network me-2"></i>{{ t('network.interfaces', 'Network Interfaces') }}
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadInterfaces()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="interfacesContainer">
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-arrow-clockwise spinning"></i>
                            <p class="mb-0 mt-2">{{ t('network.loading_interfaces', 'Loading interfaces...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Status -->
        <div class="col-xl-4 col-lg-5 mb-4">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-4 px-4">
                    <h5 class="card-title mb-0 fw-bold text-white">
                        <i class="bi bi-wifi me-2"></i>{{ t('network.status', 'Network Status') }}
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="d-flex flex-column align-items-center gap-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-online me-2"></span>
                            <span class="text-white">{{ t('network.connected', 'Connected') }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-online me-2"></span>
                            <span class="text-white">{{ t('network.internet_available', 'Internet Available') }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-online me-2"></span>
                            <span class="text-white">{{ t('network.firewall_active', 'Firewall Active') }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-warning me-2"></span>
                            <span class="text-white">{{ t('network.dhcp_running', 'DHCP Running') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Network Traffic Statistics -->
        <div class="col-xl-8 col-lg-7 mb-4">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-4 px-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 w-100">
                        <h5 class="card-title mb-0 fw-bold text-white">
                            <i class="bi bi-graph-up me-2"></i>{{ t('network.traffic', 'Network Traffic') }}
                        </h5>
                        <select class="form-select form-select-sm bg-dark text-white border-secondary" id="net-traffic-interface-select" style="min-width: 150px;">
                            <option value="">{{ t('monitoring.network_auto', 'Auto detect') }}</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('network.interface', 'Interface') }}</h6>
                            <p class="text-white mb-3" id="net-traffic-interface">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('network.ip_address', 'IP Address') }}</h6>
                            <p class="text-white mb-3" id="net-traffic-ip">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.download', 'Download') }}</h6>
                            <p class="text-white mb-2" id="net-traffic-download" style="font-size: 1.2rem; font-weight: 600;">0 B/s</p>
                            <small class="text-white-50">{{ t('monitoring.total_received', 'Total Rx') }}: <span id="net-traffic-bytes-recv">0 MB</span></small>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.upload', 'Upload') }}</h6>
                            <p class="text-white mb-2" id="net-traffic-upload" style="font-size: 1.2rem; font-weight: 600;">0 B/s</p>
                            <small class="text-white-50">{{ t('monitoring.total_sent', 'Total Tx') }}: <span id="net-traffic-bytes-sent">0 MB</span></small>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.packets', 'Packets') }}</h6>
                            <p class="text-white mb-3" id="net-traffic-packets">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.errors', 'Errors') }}</h6>
                            <p class="text-white mb-3" id="net-traffic-errors">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Traffic Chart -->
        <div class="col-xl-4 col-lg-5 mb-4">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="card-title mb-0 fw-bold text-white">
                        <i class="bi bi-graph-up me-2"></i>{{ t('monitoring.network_chart', 'Network Traffic Chart') }}
                    </h5>
                </div>
                <div class="card-body" style="position: relative; height: 250px;">
                    <canvas id="net-traffic-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Routing Table -->
        <div class="col-xl-8 col-lg-7 mb-4">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-4 px-4">
                    <h5 class="card-title mb-0 fw-bold text-white">
                        <i class="bi bi-diagram-3 me-2"></i>{{ t('network.routing_table', 'Routing Table') }}
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadRoutingTable()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>{{ t('network.destination', 'Destination') }}</th>
                                    <th>{{ t('network.gateway', 'Gateway') }}</th>
                                    <th>{{ t('network.interface', 'Interface') }}</th>
                                    <th>{{ t('network.metric', 'Metric') }}</th>
                                </tr>
                            </thead>
                            <tbody id="routingTable">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        <i class="bi bi-arrow-clockwise spinning"></i>
                                        <p class="mb-0 mt-2">{{ t('network.loading_routes', 'Loading routes...') }}</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firewall -->
        <div class="col-xl-4 col-lg-5 mb-4">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-4 px-4">
                    <h5 class="card-title mb-0 fw-bold text-white">
                        <i class="bi bi-shield-check me-2"></i>{{ t('network.firewall', 'Firewall') }}
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="d-flex flex-column align-items-center gap-3 mb-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-online me-2"></span>
                            <span class="text-white">{{ t('network.firewall_enabled', 'Firewall Enabled') }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-online me-2"></span>
                            <span class="text-white">{{ t('network.ssh_allowed', 'SSH Allowed') }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-online me-2"></span>
                            <span class="text-white">{{ t('network.http_allowed', 'HTTP Allowed') }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-offline me-2"></span>
                            <span class="text-white">{{ t('network.https_allowed', 'HTTPS Allowed') }}</span>
                        </div>
                    </div>
                    
                    <hr class="border-secondary">
                    
                    <div class="d-flex flex-column gap-2">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="toggleFirewall()">
                            <i class="bi bi-shield"></i>
                            {{ t('network.toggle_firewall', 'Toggle Firewall') }}
                        </button>
                        
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="viewFirewallRules()">
                            <i class="bi bi-list"></i>
                            {{ t('network.view_rules', 'View Rules') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Configuration -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card h-100 glass-card border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-4 px-4">
                    <h5 class="card-title mb-0 fw-bold text-white">
                        <i class="bi bi-gear me-2"></i>{{ t('network.configuration', 'Network Configuration') }}
                    </h5>
                </div>
                <div class="card-body">
                    <form id="networkConfigForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hostname" class="form-label text-white">{{ t('network.hostname', 'Hostname') }}</label>
                                    <input type="text" class="form-control" id="hostname" name="hostname" value="hostberry">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gateway" class="form-label text-white">{{ t('network.gateway', 'Gateway') }}</label>
                                    <input type="text" class="form-control" id="gateway" name="gateway" value="192.168.1.1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dns1" class="form-label text-white">{{ t('network.primary_dns', 'Primary DNS') }}</label>
                                    <input type="text" class="form-control" id="dns1" name="dns1" value="8.8.8.8">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dns2" class="form-label text-white">{{ t('network.secondary_dns', 'Secondary DNS') }}</label>
                                    <input type="text" class="form-control" id="dns2" name="dns2" value="8.8.4.4">
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check"></i>
                            {{ t('network.save_configuration', 'Save Configuration') }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/lib/chart.umd.min.js"></script>
<script>
(function(){
  // Esperar a que HostBerry esté disponible
  function waitForHostBerry(callback, maxAttempts = 50) {
    if (window.HostBerry && window.HostBerry.apiRequest && window.HostBerry.t) {
      callback();
    } else if (maxAttempts > 0) {
      setTimeout(() => waitForHostBerry(callback, maxAttempts - 1), 100);
    } else {
      console.error('HostBerry not available after waiting');
      callback(); // Intentar de todos modos
    }
  }

  // Network functionality
  async function loadInterfaces(){
    const container = document.getElementById('interfacesContainer');
    if(container){
      container.innerHTML = '<div class="text-center py-4 text-muted"><i class="bi bi-arrow-clockwise spinning"></i><p class="mb-0 mt-2">' + HostBerry.t('network.loading_interfaces', 'Loading interfaces...') + '</p></div>';
    }
    try{
        const resp = await HostBerry.apiRequest('/api/v1/system/network/interfaces');
        if(resp && resp.ok){ 
            const data = await resp.json();
            // Los datos pueden venir directamente como array o envueltos
            const interfaces = Array.isArray(data) ? data : (data.interfaces || data.data || []);
            displayInterfaces(interfaces); 
        } else {
            const errorText = resp ? await resp.text().catch(() => '') : '';
            console.error('Error loading interfaces:', errorText);
            HostBerry.showAlert('danger', HostBerry.t('errors.loading_interfaces', 'Error loading interfaces')); 
            if(container){
              container.innerHTML = '<p class="text-muted text-center">' + HostBerry.t('network.no_interfaces', 'No interfaces found') + '</p>';
            }
        }
    }catch(e){
        console.error('Exception loading interfaces:', e);
        HostBerry.showAlert('danger', HostBerry.t('errors.network_error', 'Network connection error')); 
        if(container){
          container.innerHTML = '<p class="text-muted text-center">' + HostBerry.t('network.no_interfaces', 'No interfaces found') + '</p>';
        }
    }
  }

  function displayInterfaces(interfaces){
    const container = document.getElementById('interfacesContainer'); 
    if(!container) return;
    
    if(!interfaces || !Array.isArray(interfaces) || interfaces.length===0){ 
        container.innerHTML = '<p class="text-muted text-center">'+HostBerry.t('network.no_interfaces', 'No interfaces found')+'</p>'; 
        return; 
    }
    
    console.log('Displaying interfaces:', interfaces);
    
    let html='<div class="table-responsive"><table class="table table-dark table-hover"><thead><tr><th class="text-center">'+HostBerry.t('network.interface', 'Interface')+'</th><th class="text-center">'+HostBerry.t('network.status', 'Status')+'</th><th class="text-center">'+HostBerry.t('network.ip_address', 'IP Address')+'</th><th class="text-center">'+HostBerry.t('network.mac_address', 'MAC Address')+'</th></tr></thead><tbody>';
    interfaces.forEach(function(iface){
        if(!iface) return;
        const isUp = (iface.status === 'up' || iface.status === 'connected' || iface.connected === true || (iface.status && iface.status.toLowerCase() === 'up'));
        const statusClass = isUp ? 'success' : 'danger'; 
        const statusIcon = isUp ? 'bi-check-circle' : 'bi-x-circle';
        const statusText = isUp ? HostBerry.t('network.connected', 'Connected') : HostBerry.t('network.disconnected', 'Disconnected');
        const ifaceName = iface.name || iface.interface || 'Unknown';
        const ifaceIp = iface.ip || iface.ip_address || 'N/A';
        const ifaceMac = iface.mac || iface.mac_address || 'N/A';
        html += '<tr>'
            +'<td class="text-center text-white"><strong>'+ifaceName+'</strong></td>'
            +'<td class="text-center"><span class="badge bg-'+statusClass+'"><i class="bi '+statusIcon+'"></i> '+statusText+'</span></td>'
            +'<td class="text-center text-white">'+ifaceIp+'</td>'
            +'<td class="text-center text-white">'+ifaceMac+'</td>'
            +'</tr>';
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  async function loadRoutingTable(){
    const tbody = document.getElementById('routingTable');
    if(tbody){
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted"><i class="bi bi-arrow-clockwise spinning"></i><p class="mb-0 mt-2">' + HostBerry.t('network.loading_routes', 'Loading routes...') + '</p></td></tr>';
    }
    try{
        const resp = await HostBerry.apiRequest('/api/v1/system/network/routing');
        if(resp && resp.ok){ 
            const data = await resp.json();
            // Los datos pueden venir directamente como array o envueltos
            const routes = Array.isArray(data) ? data : (data.routes || data.data || []);
            displayRoutingTable(routes); 
        } else {
            const errorText = resp ? await resp.text().catch(() => '') : '';
            console.error('Error loading routing table:', errorText);
            HostBerry.showAlert('danger', HostBerry.t('errors.loading_routing', 'Error loading routing table')); 
            if(tbody){
              tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">' + HostBerry.t('network.no_routes', 'No routes found') + '</td></tr>';
            }
        }
    }catch(e){
        console.error('Exception loading routing table:', e);
        HostBerry.showAlert('danger', HostBerry.t('errors.network_error', 'Network connection error')); 
        if(tbody){
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">' + HostBerry.t('network.no_routes', 'No routes found') + '</td></tr>';
        }
    }
  }

  function displayRoutingTable(routes){
    const tbody = document.getElementById('routingTable'); 
    if(!tbody) return;
    
    if(!routes || !Array.isArray(routes) || routes.length===0){ 
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">'+HostBerry.t('network.no_routes', 'No routes found')+'</td></tr>'; 
        return; 
    }
    
    console.log('Displaying routes:', routes);
    
    let html='';
    routes.forEach(function(route){ 
        if(!route) return;
        html += '<tr><td class="text-white">'+(route.destination || '0.0.0.0')+'</td><td class="text-white">'+(route.gateway||'*')+'</td><td class="text-white">'+(route.interface || route.dev || '-')+'</td><td class="text-white">'+(route.metric||'0')+'</td></tr>'; 
    });
    tbody.innerHTML = html;
  }

  window.toggleFirewall = async function(){
    try{
        const resp = await HostBerry.apiRequest('/api/v1/system/network/firewall/toggle', { method:'POST' });
        if(resp && resp.ok){ 
            HostBerry.showAlert('success', HostBerry.t('messages.operation_successful', 'Operation successful')); 
            setTimeout(()=>window.location.reload(), 1000); 
        }
        else { 
            HostBerry.showAlert('danger', HostBerry.t('errors.operation_failed', 'Operation failed')); 
        }
    }catch(_e){ 
        HostBerry.showAlert('danger', HostBerry.t('errors.network_error', 'Network error')); 
    }
  };

  window.viewFirewallRules = function(){ 
    alert(HostBerry.t('network.viewing_firewall_rules','Viewing firewall rules')); 
  };

  // Network Traffic Monitoring
  let selectedTrafficInterface = '';
  let lastTrafficSnapshot = null;
  let netTrafficChart = null;
  const netTrafficHistory = { labels: [], download: [], upload: [] };

  function formatBytes(bytes) {
    if (!bytes || bytes === 0 || !Number.isFinite(bytes) || bytes < 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    const sizeIndex = Math.max(0, Math.min(i, sizes.length - 1));
    const value = bytes / Math.pow(k, sizeIndex);
    return `${value.toFixed(1)} ${sizes[sizeIndex]}`;
  }

  function computeNetworkRates(current) {
    if (!current || typeof current !== 'object') {
      return {
        download_speed: 0.0,
        upload_speed: 0.0,
        bytes_recv: 0,
        bytes_sent: 0,
        interface: selectedTrafficInterface || '',
        ip_address: '--'
      };
    }
    
    const bytesRecv = typeof current.bytes_recv === 'number' && !isNaN(current.bytes_recv) ? current.bytes_recv : 0;
    const bytesSent = typeof current.bytes_sent === 'number' && !isNaN(current.bytes_sent) ? current.bytes_sent : 0;
    
    if (lastTrafficSnapshot && current.interface && lastTrafficSnapshot.interface && current.interface !== lastTrafficSnapshot.interface) {
      lastTrafficSnapshot = null;
      netTrafficHistory.labels.length = 0;
      netTrafficHistory.download.length = 0;
      netTrafficHistory.upload.length = 0;
      if (netTrafficChart) netTrafficChart.update();
    }
    
    const now = Date.now();
    if (!lastTrafficSnapshot) {
      lastTrafficSnapshot = { 
        time: now, 
        bytes_recv: bytesRecv,
        bytes_sent: bytesSent,
        interface: current.interface || selectedTrafficInterface || ''
      };
      return {
        ...current,
        download_speed: 0.0,
        upload_speed: 0.0,
        bytes_recv: bytesRecv,
        bytes_sent: bytesSent
      };
    }
    
    const timeDelta = (now - lastTrafficSnapshot.time) / 1000;
    if (timeDelta <= 0.1 || timeDelta > 60) {
      lastTrafficSnapshot = { 
        time: now, 
        bytes_recv: bytesRecv,
        bytes_sent: bytesSent,
        interface: current.interface || selectedTrafficInterface || ''
      };
      return {
        ...current,
        download_speed: 0.0,
        upload_speed: 0.0,
        bytes_recv: bytesRecv,
        bytes_sent: bytesSent
      };
    }
    
    const prevBytesRecv = lastTrafficSnapshot.bytes_recv || 0;
    const prevBytesSent = lastTrafficSnapshot.bytes_sent || 0;
    
    let bytesRecvDelta = bytesRecv - prevBytesRecv;
    let bytesSentDelta = bytesSent - prevBytesSent;
    
    if (bytesRecvDelta < 0 && Math.abs(bytesRecvDelta) > prevBytesRecv * 0.5) {
      bytesRecvDelta = bytesRecv;
    }
    if (bytesSentDelta < 0 && Math.abs(bytesSentDelta) > prevBytesSent * 0.5) {
      bytesSentDelta = bytesSent;
    }
    
    const downloadSpeed = Math.max(0, bytesRecvDelta / timeDelta);
    const uploadSpeed = Math.max(0, bytesSentDelta / timeDelta);
    
    lastTrafficSnapshot = {
      time: now,
      bytes_recv: bytesRecv,
      bytes_sent: bytesSent,
      interface: current.interface || selectedTrafficInterface || ''
    };
    
    return {
      ...current,
      download_speed: downloadSpeed,
      upload_speed: uploadSpeed,
      bytes_recv: bytesRecv,
      bytes_sent: bytesSent
    };
  }

  function pushTrafficHistory(download, upload) {
    const downloadValue = (typeof download === 'number' && !isNaN(download) && isFinite(download)) ? download : 0;
    const uploadValue = (typeof upload === 'number' && !isNaN(upload) && isFinite(upload)) ? upload : 0;
    
    const now = new Date();
    const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                      now.getMinutes().toString().padStart(2, '0') + ':' + 
                      now.getSeconds().toString().padStart(2, '0');
    
    netTrafficHistory.labels.push(timeLabel);
    netTrafficHistory.download.push(Math.max(0, downloadValue));
    netTrafficHistory.upload.push(Math.max(0, uploadValue));
    
    if (netTrafficHistory.labels.length > 30) {
      netTrafficHistory.labels.shift();
      netTrafficHistory.download.shift();
      netTrafficHistory.upload.shift();
    }
  }

  function ensureTrafficChart() {
    const canvas = document.getElementById('net-traffic-chart');
    if (!canvas) return;
    
    if (netTrafficChart) return;
    
    if (typeof Chart === 'undefined') {
      setTimeout(ensureTrafficChart, 500);
      return;
    }
    
    if (netTrafficHistory.labels.length === 0) {
      const now = new Date();
      for (let i = 9; i >= 0; i--) {
        const time = new Date(now.getTime() - i * 1000);
        const timeLabel = time.getHours().toString().padStart(2, '0') + ':' + 
                          time.getMinutes().toString().padStart(2, '0') + ':' + 
                          time.getSeconds().toString().padStart(2, '0');
        netTrafficHistory.labels.push(timeLabel);
        netTrafficHistory.download.push(0);
        netTrafficHistory.upload.push(0);
      }
    }
    
    try {
      const ctx = canvas.getContext('2d');
      netTrafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: netTrafficHistory.labels,
          datasets: [
            {
              label: HostBerry.t('monitoring.download', 'Download'),
              data: netTrafficHistory.download,
              borderColor: '#0dcaf0',
              backgroundColor: 'rgba(13, 202, 240, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 0,
              pointHoverRadius: 4
            },
            {
              label: HostBerry.t('monitoring.upload', 'Upload'),
              data: netTrafficHistory.upload,
              borderColor: '#198754',
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 0,
              pointHoverRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 0 },
          plugins: {
            legend: {
              labels: { color: '#fff' },
              display: true
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: { 
              ticks: { color: '#fff', maxRotation: 45, minRotation: 0 },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: { 
              ticks: { 
                color: '#fff',
                callback: function(value) {
                  return formatBytes(value) + '/s';
                }
              },
              grid: { color: 'rgba(255,255,255,0.1)' },
              beginAtZero: true
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    } catch (error) {
      console.error('Error creating traffic chart:', error);
    }
  }

  function populateTrafficInterfaceSelect(interfaces) {
    const select = document.getElementById('net-traffic-interface-select');
    if (!select) return;
    
    if (Array.isArray(interfaces) && interfaces.length > 0) {
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      interfaces.forEach(iface => {
        const ifaceName = (typeof iface === 'string') ? iface : (iface.name || iface);
        if (ifaceName && ifaceName !== 'lo') {
          const option = document.createElement('option');
          option.value = ifaceName;
          option.textContent = ifaceName;
          if (ifaceName === selectedTrafficInterface) {
            option.selected = true;
          }
          select.appendChild(option);
        }
      });
    }
  }

  async function updateTrafficStats() {
    try {
      // Agregar timestamp para evitar caché del navegador
      const cacheBuster = `&_t=${Date.now()}`;
      const url = `/api/v1/system/network${selectedTrafficInterface ? `?interface=${encodeURIComponent(selectedTrafficInterface)}` : ''}${cacheBuster}`;
      const resp = await HostBerry.apiRequest(url);
      
      if (!resp || !resp.ok) {
        throw new Error('Network request failed');
      }
      
      const networkStatsRaw = await resp.json();
      if (!networkStatsRaw || typeof networkStatsRaw !== 'object') {
        throw new Error('Invalid network stats response');
      }
      
      const networkStats = computeNetworkRates(networkStatsRaw);
      
      if (networkStats.interfaces && Array.isArray(networkStats.interfaces)) {
        populateTrafficInterfaceSelect(networkStats.interfaces);
      } else if (networkStatsRaw.interfaces && Array.isArray(networkStatsRaw.interfaces)) {
        populateTrafficInterfaceSelect(networkStatsRaw.interfaces);
      }

      // Actualizar estadísticas
      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };

      setText('net-traffic-interface', networkStats.interface || networkStatsRaw.interface || '--');
      setText('net-traffic-ip', networkStats.ip_address || networkStatsRaw.ip_address || '--');
      
      const downloadSpeed = networkStats.download_speed || 0;
      const uploadSpeed = networkStats.upload_speed || 0;
      
      const downloadText = downloadSpeed > 0 ? formatBytes(downloadSpeed) + '/s' : '0 B/s';
      const uploadText = uploadSpeed > 0 ? formatBytes(uploadSpeed) + '/s' : '0 B/s';
      
      setText('net-traffic-download', downloadText);
      setText('net-traffic-upload', uploadText);
      
      const bytesRecv = networkStats.bytes_recv || networkStatsRaw.bytes_recv || 0;
      const bytesSent = networkStats.bytes_sent || networkStatsRaw.bytes_sent || 0;
      setText('net-traffic-bytes-recv', formatBytes(bytesRecv));
      setText('net-traffic-bytes-sent', formatBytes(bytesSent));
      
      const packetsSent = networkStats.packets_sent || networkStatsRaw.packets_sent || 0;
      const packetsRecv = networkStats.packets_recv || networkStatsRaw.packets_recv || 0;
      setText('net-traffic-packets', `${packetsSent} / ${packetsRecv}`);
      
      const errors = (networkStats.errors || networkStatsRaw.errors || 0) + 
                     (networkStats.drop || networkStatsRaw.drop || 0);
      setText('net-traffic-errors', errors || '0');

      // Agregar al historial
      const validDownloadSpeed = (typeof downloadSpeed === 'number' && !isNaN(downloadSpeed) && isFinite(downloadSpeed)) ? downloadSpeed : 0;
      const validUploadSpeed = (typeof uploadSpeed === 'number' && !isNaN(uploadSpeed) && isFinite(uploadSpeed)) ? uploadSpeed : 0;
      
      pushTrafficHistory(validDownloadSpeed, validUploadSpeed);

      ensureTrafficChart();
      
      if (netTrafficChart) {
        netTrafficChart.data.labels = [...netTrafficHistory.labels];
        netTrafficChart.data.datasets[0].data = [...netTrafficHistory.download];
        netTrafficChart.data.datasets[1].data = [...netTrafficHistory.upload];
        netTrafficChart.data.datasets[0].label = HostBerry.t('monitoring.download', 'Download');
        netTrafficChart.data.datasets[1].label = HostBerry.t('monitoring.upload', 'Upload');
        netTrafficChart.update('none');
      }
    } catch (error) {
      console.error('Error updating traffic stats:', error);
    }
  }

  function initNetworkPage() {
    loadInterfaces();
    loadRoutingTable();
    
    // Inicializar monitoreo de tráfico
    const trafficSelect = document.getElementById('net-traffic-interface-select');
    if (trafficSelect) {
      trafficSelect.addEventListener('change', function(e) {
        selectedTrafficInterface = e.target.value || '';
        lastTrafficSnapshot = null;
        netTrafficHistory.labels.length = 0;
        netTrafficHistory.download.length = 0;
        netTrafficHistory.upload.length = 0;
        if (netTrafficChart) netTrafficChart.update();
        updateTrafficStats();
      });
    }
    
    // Iniciar actualizaciones de tráfico
    updateTrafficStats();
    setInterval(updateTrafficStats, 5000);
    
    const configForm = document.getElementById('networkConfigForm');
    if(configForm){
        configForm.addEventListener('submit', async function(e){
            e.preventDefault(); 
            const fd = new FormData(this);
            const data = { 
                hostname: fd.get('hostname'), 
                dns1: fd.get('dns1'), 
                dns2: fd.get('dns2'), 
                gateway: fd.get('gateway') 
            };
            try{
                const resp = await HostBerry.apiRequest('/api/v1/system/network/config', {
                    method: 'POST',
                    body: data
                });
                if(resp && resp.ok){
                    HostBerry.showAlert('success', HostBerry.t('messages.config_saved', 'Configuration saved'));
                } else {
                    HostBerry.showAlert('danger', HostBerry.t('errors.config_update_error', 'Error updating configuration'));
                }
            }catch(_e){
                HostBerry.showAlert('danger', HostBerry.t('errors.network_error', 'Network error'));
            }
        });
    }
  }

  // Exportar funciones para los botones onclick
  window.loadInterfaces = loadInterfaces;
  window.loadRoutingTable = loadRoutingTable;

  // Iniciar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => waitForHostBerry(initNetworkPage));
  } else {
    waitForHostBerry(initNetworkPage);
  }
})();
</script>
{% endblock %}