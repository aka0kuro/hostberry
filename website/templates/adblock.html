 
<div class="row">
    <!-- Vista General de AdBlock -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-x"></i>
                    {{ call .t "adblock.overview" "Overview" }}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <i class="bi bi-list text-primary" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">{{ call .t "adblock.lists" "Lists" }}</h6>
                            <h4 class="text-primary">{{ if .adblock_stats.lists_count }}{{ .adblock_stats.lists_count }}{{ else }}3{{ end }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <i class="bi bi-globe text-success" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">{{ call .t "adblock.domains" "Domains" }}</h6>
                            <h4 class="text-success">{{ if .adblock_stats.domains_count }}{{ .adblock_stats.domains_count }}{{ else }}50000{{ end }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <i class="bi bi-shield-check text-warning" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">{{ call .t "adblock.blocked_domains" "Blocked" }}</h6>
                            <h4 class="text-warning">{{ if .adblock_stats.blocked_count }}{{ .adblock_stats.blocked_count }}{{ else }}1500{{ end }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <i class="bi bi-clock text-info" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">{{ call .t "adblock.last_update" "Last Update" }}</h6>
                            <h4 class="text-info">{{ if .adblock_stats.last_update }}{{ .adblock_stats.last_update }}{{ else }}2 horas{{ end }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado de AdBlock -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-heart-pulse"></i>
                    {{ call .t "adblock.status" "Status" }}
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <span class="status-indicator status-{{ if .adblock_status.enabled }}online{{ else }}offline{{ end }}"></span>
                    <span>{{ if .adblock_status.enabled }}{{ call .t "adblock.adblock_enabled" "Enabled" }}{{ else }}{{ call .t "adblock.adblock_disabled" "Disabled" }}{{ end }}</span>
                </div>
                
                <div class="d-flex align-items-center mb-3">
                    <span class="status-indicator status-{{ if .adblock_status.running }}online{{ else }}offline{{ end }}"></span>
                    <span>{{ if .adblock_status.running }}{{ call .t "adblock.adblock_running" "Running" }}{{ else }}{{ call .t "adblock.adblock_stopped" "Stopped" }}{{ end }}</span>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">{{ call .t "adblock.blocked_today" "Blocked Today" }}</label>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-shield-x text-danger me-2"></i>
                        <span class="h6 mb-0">{{ if .adblock_status.blocked_today }}{{ .adblock_status.blocked_today }}{{ else }}45{{ end }}</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">{{ call .t "adblock.whitelisted_domains" "Whitelisted" }}</label>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-shield-check text-success me-2"></i>
                        <span class="h6 mb-0">{{ if .adblock_status.whitelisted_count }}{{ .adblock_status.whitelisted_count }}{{ else }}25{{ end }}</span>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-success" onclick="toggleAdBlock()">
                        <i class="bi bi-shield-x"></i>
                        {{ if .adblock_status.enabled }}{{ call .t "adblock.disable_adblock" "Disable" }}{{ else }}{{ call .t "adblock.enable_adblock" "Enable" }}{{ end }}
                    </button>
                    <button class="btn btn-outline-primary" onclick="updateLists()">
                        <i class="bi bi-arrow-clockwise"></i>
                        {{ call .t "adblock.update_lists" "Update Lists" }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Listas de AdBlock -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list"></i>
                    {{ call .t "adblock.lists" "Lists" }}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>{{ call .t "adblock.list_name" "Name" }}</th>
                                <th>{{ call .t "adblock.list_status" "Status" }}</th>
                                <th>{{ call .t "adblock.list_domains" "Domains" }}</th>
                                <th>{{ call .t "adblock.list_last_update" "Last Update" }}</th>
                                <th>{{ call .t "common.actions" "Actions" }}</th>
                            </tr>
                        </thead>
                        <tbody id="listsTable">
                            <!-- Las listas se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuración de AdBlock -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    {{ call .t "adblock.configuration" "Configuration" }}
                </h5>
            </div>
            <div class="card-body">
                <form id="adblockConfigForm">
                    <div class="mb-3">
                        <label for="update_interval" class="form-label">{{ call .t "adblock.update_interval" "Update Interval" }}</label>
                        <select class="form-select" id="update_interval" name="update_interval">
                            <option value="daily" {{ if eq .adblock_config.update_interval "daily" }}selected{{ end }}>Daily</option>
                            <option value="weekly" {{ if eq .adblock_config.update_interval "weekly" }}selected{{ end }}>Weekly</option>
                            <option value="monthly" {{ if eq .adblock_config.update_interval "monthly" }}selected{{ end }}>Monthly</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="max_lists" class="form-label">{{ call .t "adblock.max_lists" "Max Lists" }}</label>
                        <input type="number" class="form-control" id="max_lists" name="max_lists" value="{{ if .adblock_config.max_lists }}{{ .adblock_config.max_lists }}{{ else }}5{{ end }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="cache_size" class="form-label">{{ call .t "adblock.cache_size" "Cache Size" }}</label>
                        <input type="number" class="form-control" id="cache_size" name="cache_size" value="{{ if .adblock_config.cache_size }}{{ .adblock_config.cache_size }}{{ else }}50{{ end }}">
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i>
                            {{ call .t "common.save" "Save" }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dominios Bloqueados -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-x"></i>
                    {{ call .t "adblock.blocked_domains" "Blocked Domains" }}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>{{ call .t "adblock.domain_name" "Domain" }}</th>
                                <th>{{ call .t "adblock.domain_status" "Status" }}</th>
                                <th>{{ call .t "common.actions" "Actions" }}</th>
                            </tr>
                        </thead>
                        <tbody id="domainsTable">
                            <!-- Los dominios se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas de AdBlock -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i>
                    {{ call .t "adblock.statistics" "Statistics" }}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h6>{{ call .t "adblock.total_blocked" "Total Blocked" }}</h6>
                            <h4 class="text-danger">{{ if .adblock_stats.total_blocked }}{{ .adblock_stats.total_blocked }}{{ else }}1500{{ end }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h6>{{ call .t "adblock.blocked_today" "Blocked Today" }}</h6>
                            <h4 class="text-warning">{{ if .adblock_stats.blocked_today }}{{ .adblock_stats.blocked_today }}{{ else }}45{{ end }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h6>{{ call .t "adblock.whitelisted" "Whitelisted" }}</h6>
                            <h4 class="text-success">{{ if .adblock_stats.whitelisted }}{{ .adblock_stats.whitelisted }}{{ else }}25{{ end }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h6>{{ call .t "adblock.uptime" "Uptime" }}</h6>
                            <h4 class="text-info">{{ if .adblock_stats.uptime }}{{ .adblock_stats.uptime }}{{ else }}10 días{{ end }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para cargar listas de AdBlock
async function loadLists() {
    try {
        const response = await fetch('/api/v1/adblock/lists', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            const lists = await response.json();
            const tbody = document.getElementById('listsTable');
            tbody.innerHTML = '';
            
            lists.forEach(list => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${list.name}</td>
                    <td>
                        <span class="badge bg-${list.enabled ? 'success' : 'danger'}">
                            ${list.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td>${list.domains_count}</td>
                    <td>${list.last_update}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleList('${list.name}')">
                            <i class="bi bi-${list.enabled ? 'pause' : 'play'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading lists:', error);
    }
}

// Función para cargar dominios bloqueados
async function loadDomains() {
    try {
        const response = await fetch('/api/v1/adblock/domains', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            const domains = await response.json();
            const tbody = document.getElementById('domainsTable');
            tbody.innerHTML = '';
            
            domains.slice(0, 10).forEach(domain => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${domain.name}</td>
                    <td>
                        <span class="badge bg-${domain.blocked ? 'danger' : 'success'}">
                            ${domain.blocked ? 'Blocked' : 'Allowed'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-${domain.blocked ? 'success' : 'danger'}" onclick="toggleDomain('${domain.name}')">
                            <i class="bi bi-${domain.blocked ? 'check' : 'x'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading domains:', error);
    }
}

// Función para alternar AdBlock
async function toggleAdBlock() {
    try {
        const response = await fetch('/api/v1/adblock/toggle', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            showAlert('success', t('messages.operation_successful'));
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert('danger', t('errors.operation_failed'));
        }
    } catch (error) {
        showAlert('danger', t('errors.network_error'));
    }
}

// Función para actualizar listas
async function updateLists() {
    try {
        const response = await fetch('/api/v1/adblock/update', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            showAlert('info', t('adblock.updating_lists'));
            setTimeout(() => {
                loadLists();
            }, 5000);
        } else {
            showAlert('danger', t('errors.operation_failed'));
        }
    } catch (error) {
        showAlert('danger', t('errors.network_error'));
    }
}

// Función para alternar lista
async function toggleList(listName) {
    try {
        const response = await fetch(`/api/v1/adblock/lists/${listName}/toggle`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            showAlert('success', t('messages.operation_successful'));
            setTimeout(() => {
                loadLists();
            }, 1000);
        } else {
            showAlert('danger', t('errors.operation_failed'));
        }
    } catch (error) {
        showAlert('danger', t('errors.network_error'));
    }
}

// Función para alternar dominio
async function toggleDomain(domainName) {
    try {
        const response = await fetch(`/api/v1/adblock/domains/${domainName}/toggle`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            showAlert('success', t('messages.operation_successful'));
            setTimeout(() => {
                loadDomains();
            }, 1000);
        } else {
            showAlert('danger', t('errors.operation_failed'));
        }
    } catch (error) {
        showAlert('danger', t('errors.network_error'));
    }
}

// Función para guardar configuración de AdBlock
document.getElementById('adblockConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        update_interval: formData.get('update_interval'),
        max_lists: parseInt(formData.get('max_lists')),
        cache_size: parseInt(formData.get('cache_size'))
    };
    
    try {
        const response = await fetch('/api/v1/adblock/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showAlert('success', t('messages.changes_saved'));
        } else {
            showAlert('danger', t('errors.configuration_error'));
        }
    } catch (error) {
        showAlert('danger', t('errors.network_error'));
    }
});

// Función para mostrar alertas
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Función de traducción para JavaScript
function t(key, defaultValue = '') {
    const keys = key.split('.');
    let value = window.translations;
    
    for (const k of keys) {
        if (value && typeof value === 'object' && k in value) {
            value = value[k];
        } else {
            return defaultValue || key;
        }
    }
    
    return typeof value === 'string' ? value : (defaultValue || key);
}

// Cargar datos al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    loadLists();
    loadDomains();
    
    // Auto-refresh cada 30 segundos
    setInterval(() => {
        loadLists();
        loadDomains();
    }, 30000);
});
</script>
