{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-12 text-center">
                <h1 class="dashboard-title">
                    <i class="bi bi-activity me-2"></i>
                    {{ t('monitoring.title', 'Monitoring Control Room') }}
                </h1>
                <p class="dashboard-subtitle">{{ t('monitoring.subtitle', 'Real-time insight on your HostBerry performance data') }}</p>
                <div class="dashboard-time">
                    <i class="bi bi-clock me-1"></i>
                    {{ t('monitoring.last_update', 'Last update') }}: <span id="monitoring-last-update">--:--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information Cards -->
    <div class="row mb-4">
        <!-- Uptime -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h6 class="actions-card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        {{ t('monitoring.uptime', 'Uptime') }}
                    </h6>
                </div>
                <div class="actions-card-body text-center">
                    <h2 class="text-white mb-2" id="uptime-value">--</h2>
                    <small class="text-white-50">{{ t('monitoring.since_boot', 'Since boot') }}</small>
                </div>
            </div>
        </div>

        <!-- CPU Usage -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h6 class="actions-card-title mb-0">
                        <i class="bi bi-cpu me-2"></i>
                        {{ t('monitoring.cpu_usage', 'CPU Usage') }}
                    </h6>
                </div>
                <div class="actions-card-body">
                    <div class="text-center mb-2">
                        <h2 class="text-white mb-0" id="cpu-usage">0%</h2>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div id="cpu-progress" class="progress-bar bg-info" style="width:0%"></div>
                    </div>
                    <div class="d-flex justify-content-between text-white-50 small">
                        <span>{{ t('monitoring.cores', 'Cores') }}: <strong id="cpu-cores">-</strong></span>
                        <span>{{ t('monitoring.temp', 'Temp') }}: <strong id="cpu-temp">--°C</strong></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Memory Usage -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h6 class="actions-card-title mb-0">
                        <i class="bi bi-memory me-2"></i>
                        {{ t('monitoring.memory_usage', 'Memory Usage') }}
                    </h6>
                </div>
                <div class="actions-card-body">
                    <div class="text-center mb-2">
                        <h2 class="text-white mb-0" id="mem-usage">0%</h2>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div id="mem-progress" class="progress-bar bg-success" style="width:0%"></div>
                    </div>
                    <div class="text-center text-white-50 small">
                        <span>{{ t('monitoring.used_of', 'Used of') }} <strong id="mem-total">0 GB</strong> · <span id="mem-free">0 GB</span> {{ t('monitoring.free', 'free') }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disk Usage -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h6 class="actions-card-title mb-0">
                        <i class="bi bi-hdd me-2"></i>
                        {{ t('monitoring.disk_usage', 'Disk Usage') }}
                    </h6>
                </div>
                <div class="actions-card-body">
                    <div class="text-center mb-2">
                        <h2 class="text-white mb-0" id="disk-usage">0%</h2>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div id="disk-progress" class="progress-bar bg-warning" style="width:0%"></div>
                    </div>
                    <div class="text-center text-white-50 small">
                        <span>{{ t('monitoring.used', 'Used') }} <strong id="disk-used">0 GB</strong> / <span id="disk-total">0 GB</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information and Network Statistics -->
    <div class="row mb-4">
        <!-- System Information -->
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h5 class="actions-card-title">
                        <i class="bi bi-info-circle me-2"></i>
                        {{ t('monitoring.system_info', 'System Information') }}
                    </h5>
                </div>
                <div class="actions-card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.hostname', 'Hostname') }}</h6>
                            <p class="text-white mb-3" id="sys-hostname">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.os_version', 'OS Version') }}</h6>
                            <p class="text-white mb-3" id="sys-os">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.kernel', 'Kernel') }}</h6>
                            <p class="text-white mb-3" id="sys-kernel">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.architecture', 'Architecture') }}</h6>
                            <p class="text-white mb-3" id="sys-arch">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.processor', 'Processor') }}</h6>
                            <p class="text-white mb-3" id="sys-processor">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">
                                {{ t('monitoring.load_average', 'Load Average') }}
                                <i class="bi bi-question-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ t('monitoring.load_average_desc', 'System load: 1min, 5min, 15min averages') }}"></i>
                            </h6>
                            <p class="text-white mb-3" id="sys-load">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Statistics -->
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="actions-card">
                <div class="actions-card-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="actions-card-title mb-0">
                            <i class="bi bi-wifi me-2"></i>
                            {{ t('monitoring.network_stats', 'Network Statistics') }}
                        </h5>
                        <select class="form-select form-select-sm bg-dark text-white border-secondary" id="net-interface-select" style="min-width: 150px;">
                            <option value="">{{ t('monitoring.network_auto', 'Auto detect') }}</option>
                        </select>
                    </div>
                </div>
                <div class="actions-card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.interface', 'Interface') }}</h6>
                            <p class="text-white mb-3" id="net-interface">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.ip_address', 'IP Address') }}</h6>
                            <p class="text-white mb-3" id="net-ip">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.download', 'Download') }}</h6>
                            <p class="text-white mb-2" id="net-download" style="font-size: 1.2rem; font-weight: 600;">0 KB/s</p>
                            <small class="text-white-50">{{ t('monitoring.total_received', 'Total Rx') }}: <span id="net-bytes-recv">0 MB</span></small>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.upload', 'Upload') }}</h6>
                            <p class="text-white mb-2" id="net-upload" style="font-size: 1.2rem; font-weight: 600;">0 KB/s</p>
                            <small class="text-white-50">{{ t('monitoring.total_sent', 'Total Tx') }}: <span id="net-bytes-sent">0 MB</span></small>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.packets', 'Packets') }}</h6>
                            <p class="text-white mb-3" id="net-packets">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.errors', 'Errors') }}</h6>
                            <p class="text-white mb-3" id="net-errors">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Traffic Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h5 class="actions-card-title">
                        <i class="bi bi-graph-up me-2"></i>
                        {{ t('monitoring.network_chart', 'Network Traffic Chart') }}
                    </h5>
                </div>
                <div class="actions-card-body" style="position: relative; height: 300px;">
                    <canvas id="net-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/lib/chart.umd.min.js"></script>
<script>
(function(){
  // Esperar a que Chart.js esté cargado
  if (typeof Chart === 'undefined') {
    const checkChart = setInterval(function() {
      if (typeof Chart !== 'undefined') {
        clearInterval(checkChart);
        initMonitoring();
      }
    }, 100);
    setTimeout(function() {
      clearInterval(checkChart);
      if (typeof Chart !== 'undefined') {
        initMonitoring();
      } else {
        console.error('Chart.js failed to load');
      }
    }, 5000);
  } else {
    initMonitoring();
  }

  function initMonitoring() {
    // Esperar a que HostBerry esté disponible
    function waitForHostBerry(callback, maxAttempts = 50) {
      if (window.HostBerry && window.HostBerry.apiRequest && window.HostBerry.t) {
        callback();
      } else if (maxAttempts > 0) {
        setTimeout(() => waitForHostBerry(callback, maxAttempts - 1), 100);
      } else {
        console.error('HostBerry not available');
        callback(); // Continuar de todos modos
      }
    }

    // Función de traducción
    function t(key, defaultValue) {
      if (window.HostBerry && window.HostBerry.t) {
        return window.HostBerry.t(key, defaultValue);
      }
      return defaultValue || key;
    }

    // Utilidades
    const setText = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    };

    function safeToFixed(value, digits = 1) {
      if (value === null || value === undefined) return '0.0';
      const num = typeof value === 'number' ? value : parseFloat(value);
      if (Number.isNaN(num) || !Number.isFinite(num)) return '0.0';
      return num.toFixed(digits);
    }

    function formatUptime(seconds) {
      if (!Number.isFinite(seconds) || seconds < 0) return '--';
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor(((seconds % 86400) % 3600) / 60);
      if (days > 0) return `${days}d ${hours}h ${minutes}m`;
      if (hours > 0) return `${hours}h ${minutes}m`;
      return `${minutes}m`;
    }

    function formatBytes(bytes) {
      if (!Number.isFinite(bytes) || bytes < 0 || bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      const sizeIndex = Math.max(0, Math.min(i, sizes.length - 1));
      return `${safeToFixed(bytes / Math.pow(k, sizeIndex), 1)} ${sizes[sizeIndex]}`;
    }

    function updateProgress(id, percent) {
      const el = document.getElementById(id);
      if (el) {
        const safePercent = Math.min(100, Math.max(0, percent));
        el.style.width = safePercent + '%';
      }
    }

    // Variables globales
    let selectedInterface = '';
    let lastNetSnapshot = null;
    let netChart = null;
    const netHistory = { labels: [], download: [], upload: [] };

    // Poblar selector de interfaces
    function populateInterfaceSelect(interfaces) {
      const select = document.getElementById('net-interface-select');
      if (!select) return;
      
      if (Array.isArray(interfaces) && interfaces.length > 0) {
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        interfaces.forEach(iface => {
          const ifaceName = (typeof iface === 'string') ? iface : (iface.name || iface);
          if (ifaceName && ifaceName !== 'lo') {
            const option = document.createElement('option');
            option.value = ifaceName;
            option.textContent = ifaceName;
            if (ifaceName === selectedInterface) {
              option.selected = true;
            }
            select.appendChild(option);
          }
        });
      }
    }

    // Calcular velocidades de red
    function computeNetworkRates(current) {
      if (!current || typeof current !== 'object') {
        return {
          download_speed: 0.0,
          upload_speed: 0.0,
          bytes_recv: 0,
          bytes_sent: 0,
          packets_sent: 0,
          packets_recv: 0,
          errors: 0,
          interface: selectedInterface || '',
          ip_address: '--',
          interfaces: []
        };
      }
      
      const bytesRecv = typeof current.bytes_recv === 'number' && !isNaN(current.bytes_recv) ? current.bytes_recv : 0;
      const bytesSent = typeof current.bytes_sent === 'number' && !isNaN(current.bytes_sent) ? current.bytes_sent : 0;
      
      // Resetear si cambia la interfaz
      if (lastNetSnapshot && current.interface && lastNetSnapshot.interface && current.interface !== lastNetSnapshot.interface) {
        lastNetSnapshot = null;
        netHistory.labels.length = 0;
        netHistory.download.length = 0;
        netHistory.upload.length = 0;
        if (netChart) netChart.update();
      }
      
      const now = Date.now();
      
      // Primera vez o reset
      if (!lastNetSnapshot) {
        lastNetSnapshot = { 
          time: now, 
          bytes_recv: bytesRecv,
          bytes_sent: bytesSent,
          interface: current.interface || selectedInterface || ''
        };
        console.log('Network snapshot initialized:', {
          bytes_recv: bytesRecv,
          bytes_sent: bytesSent,
          interface: current.interface
        });
        return {
          ...current,
          download_speed: 0.0,
          upload_speed: 0.0,
          bytes_recv: bytesRecv,
          bytes_sent: bytesSent
        };
      }
      
      // Calcular tiempo transcurrido
      const timeDelta = (now - lastNetSnapshot.time) / 1000;
      
      // Validar tiempo delta (debe ser entre 0.1 y 60 segundos)
      if (timeDelta <= 0.1 || timeDelta > 60) {
        console.log('Invalid timeDelta, resetting snapshot:', timeDelta);
        lastNetSnapshot = { 
          time: now, 
          bytes_recv: bytesRecv,
          bytes_sent: bytesSent,
          interface: current.interface || selectedInterface || ''
        };
        return {
          ...current,
          download_speed: 0.0,
          upload_speed: 0.0,
          bytes_recv: bytesRecv,
          bytes_sent: bytesSent
        };
      }
      
      // Calcular diferencias
      const prevBytesRecv = lastNetSnapshot.bytes_recv || 0;
      const prevBytesSent = lastNetSnapshot.bytes_sent || 0;
      
      let bytesRecvDelta = bytesRecv - prevBytesRecv;
      let bytesSentDelta = bytesSent - prevBytesSent;
      
      // Manejar reset de contadores (si los bytes disminuyen significativamente, asumir reset)
      if (bytesRecvDelta < 0 && Math.abs(bytesRecvDelta) > prevBytesRecv * 0.5) {
        console.log('Detected bytes_recv counter reset');
        bytesRecvDelta = bytesRecv; // Asumir que empezó desde 0
      }
      if (bytesSentDelta < 0 && Math.abs(bytesSentDelta) > prevBytesSent * 0.5) {
        console.log('Detected bytes_sent counter reset');
        bytesSentDelta = bytesSent; // Asumir que empezó desde 0
      }
      
      // Calcular velocidades en bytes/s
      const downloadSpeed = Math.max(0, bytesRecvDelta / timeDelta);
      const uploadSpeed = Math.max(0, bytesSentDelta / timeDelta);
      
      // Log para depuración (solo cada 5 actualizaciones)
      if (Math.random() < 0.2) {
        console.log('Network rates:', {
          timeDelta: timeDelta.toFixed(2),
          bytesRecvDelta: bytesRecvDelta,
          bytesSentDelta: bytesSentDelta,
          downloadSpeed: downloadSpeed.toFixed(2) + ' B/s',
          uploadSpeed: uploadSpeed.toFixed(2) + ' B/s'
        });
      }
      
      // Actualizar snapshot
      lastNetSnapshot = {
        time: now,
        bytes_recv: bytesRecv,
        bytes_sent: bytesSent,
        interface: current.interface || selectedInterface || ''
      };
      
      return {
        ...current,
        download_speed: downloadSpeed,
        upload_speed: uploadSpeed,
        bytes_recv: bytesRecv,
        bytes_sent: bytesSent
      };
    }

    // Agregar datos al historial del gráfico
    function pushNetHistory(download, upload) {
      const downloadValue = (typeof download === 'number' && !isNaN(download) && isFinite(download)) ? download : 0;
      const uploadValue = (typeof upload === 'number' && !isNaN(upload) && isFinite(upload)) ? upload : 0;
      
      const now = new Date();
      const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0') + ':' + 
                        now.getSeconds().toString().padStart(2, '0');
      
      netHistory.labels.push(timeLabel);
      netHistory.download.push(Math.max(0, downloadValue));
      netHistory.upload.push(Math.max(0, uploadValue));
      
      if (netHistory.labels.length > 30) {
        netHistory.labels.shift();
        netHistory.download.shift();
        netHistory.upload.shift();
      }
    }

    // Inicializar gráfico
    function ensureNetChart() {
      const canvas = document.getElementById('net-chart');
      if (!canvas) {
        console.warn('Canvas element not found');
        return;
      }
      
      if (netChart) return;
      
      if (typeof Chart === 'undefined') {
        setTimeout(ensureNetChart, 500);
        return;
      }
      
      // Inicializar con datos por defecto
      if (netHistory.labels.length === 0) {
        const now = new Date();
        for (let i = 9; i >= 0; i--) {
          const time = new Date(now.getTime() - i * 1000);
          const timeLabel = time.getHours().toString().padStart(2, '0') + ':' + 
                            time.getMinutes().toString().padStart(2, '0') + ':' + 
                            time.getSeconds().toString().padStart(2, '0');
          netHistory.labels.push(timeLabel);
          netHistory.download.push(0);
          netHistory.upload.push(0);
        }
      }
      
      try {
        const ctx = canvas.getContext('2d');
        netChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: netHistory.labels,
            datasets: [
              {
                label: t('monitoring.download', 'Download'),
                data: netHistory.download,
                borderColor: '#0dcaf0',
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 4
              },
              {
                label: t('monitoring.upload', 'Upload'),
                data: netHistory.upload,
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            plugins: {
              legend: {
                labels: { color: '#fff' },
                display: true
              },
              tooltip: {
                mode: 'index',
                intersect: false
              }
            },
            scales: {
              x: { 
                ticks: { color: '#fff', maxRotation: 45, minRotation: 0 },
                grid: { color: 'rgba(255,255,255,0.1)' }
              },
              y: { 
                ticks: { 
                  color: '#fff',
                  callback: function(value) {
                    return formatBytes(value) + '/s';
                  }
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                beginAtZero: true
              }
            },
            interaction: {
              mode: 'nearest',
              axis: 'x',
              intersect: false
            }
          }
        });
        console.log('Network chart initialized');
      } catch (error) {
        console.error('Error creating network chart:', error);
      }
    }

    // Obtener datos JSON
    async function fetchJson(url) {
      try {
        if (!window.HostBerry || !window.HostBerry.apiRequest) {
          const token = localStorage.getItem('access_token');
          const resp = await fetch(url, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (resp.status === 401) {
            window.location.href = '/login';
            throw new Error('Unauthorized');
          }
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
          }
          
          const data = await resp.json();
          return data.data !== undefined ? data.data : data;
        }
        
        const resp = await window.HostBerry.apiRequest(url);
        if (!resp) throw new Error('No response');
        
        if (resp.status === 401) {
          window.location.href = '/login';
          throw new Error('Unauthorized');
        }
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        
        const data = await resp.json();
        return data.data !== undefined ? data.data : data;
      } catch (error) {
        console.error('fetchJson error:', url, error);
        throw error;
      }
    }

    // Actualizar estadísticas
    async function updateStats() {
      try {
        const [systemStatsResp, networkStatsResp] = await Promise.all([
          fetchJson('/api/v1/system/stats'),
          fetchJson(`/api/v1/system/network${selectedInterface ? `?interface=${encodeURIComponent(selectedInterface)}` : ''}`)
        ]);
        
        let systemStats = systemStatsResp;
        if (!systemStats || typeof systemStats !== 'object') {
          throw new Error('Invalid system stats response');
        }
        
        let networkStatsRaw = networkStatsResp;
        if (!networkStatsRaw || typeof networkStatsRaw !== 'object') {
          throw new Error('Invalid network stats response');
        }
        
        const networkStats = computeNetworkRates(networkStatsRaw);
        
        if (networkStats.interfaces && Array.isArray(networkStats.interfaces)) {
          populateInterfaceSelect(networkStats.interfaces);
        } else if (networkStatsRaw.interfaces && Array.isArray(networkStatsRaw.interfaces)) {
          populateInterfaceSelect(networkStatsRaw.interfaces);
        }

        // Actualizar uptime
        const uptime = systemStats.uptime || systemStats.uptime_seconds || 0;
        setText('uptime-value', formatUptime(uptime));
        
        // Actualizar CPU
        const cpuUsage = systemStats.cpu_usage;
        let cpuUsageValue = 0;
        if (cpuUsage !== null && cpuUsage !== undefined) {
          cpuUsageValue = typeof cpuUsage === 'number' ? cpuUsage : parseFloat(cpuUsage);
          if (Number.isNaN(cpuUsageValue)) cpuUsageValue = 0;
        }
        setText('cpu-usage', `${safeToFixed(cpuUsageValue)}%`);
        updateProgress('cpu-progress', cpuUsageValue);
        
        const cpuTemp = systemStats.cpu_temperature || 0;
        if (typeof cpuTemp === 'number' && cpuTemp > 0) {
          setText('cpu-temp', `${safeToFixed(cpuTemp)}°C`);
        } else {
          setText('cpu-temp', '--°C');
        }
        
        const cpuCores = systemStats.cpu_cores || 0;
        setText('cpu-cores', cpuCores ? String(cpuCores) : '-');

        // Actualizar Memoria
        const memUsage = systemStats.memory_usage;
        let memUsageValue = 0;
        if (memUsage !== null && memUsage !== undefined) {
          memUsageValue = typeof memUsage === 'number' ? memUsage : parseFloat(memUsage);
          if (Number.isNaN(memUsageValue)) memUsageValue = 0;
        }
        setText('mem-usage', `${safeToFixed(memUsageValue)}%`);
        updateProgress('mem-progress', memUsageValue);
        
        const memTotal = systemStats.memory_total || 0;
        if (memTotal && memTotal > 0) {
          setText('mem-total', formatBytes(memTotal));
        } else {
          setText('mem-total', '0 GB');
        }
        
        const memFree = systemStats.memory_free || 0;
        if (memFree && memFree > 0) {
          setText('mem-free', formatBytes(memFree));
        } else {
          setText('mem-free', '0 GB');
        }

        // Actualizar Disco
        const diskUsage = systemStats.disk_usage;
        let diskUsageValue = 0;
        if (diskUsage !== null && diskUsage !== undefined) {
          diskUsageValue = typeof diskUsage === 'number' ? diskUsage : parseFloat(diskUsage);
          if (Number.isNaN(diskUsageValue)) diskUsageValue = 0;
        }
        setText('disk-usage', `${safeToFixed(diskUsageValue)}%`);
        updateProgress('disk-progress', diskUsageValue);
        
        const diskTotal = systemStats.disk_total || 0;
        if (diskTotal && diskTotal > 0) {
          setText('disk-total', formatBytes(diskTotal));
        } else {
          setText('disk-total', '0 GB');
        }
        
        const diskUsed = systemStats.disk_used || 0;
        if (diskUsed && diskUsed > 0) {
          setText('disk-used', formatBytes(diskUsed));
        } else {
          setText('disk-used', '0 GB');
        }

        // Actualizar información del sistema
        setText('sys-hostname', systemStats.hostname || '--');
        setText('sys-os', systemStats.os_version || '--');
        setText('sys-kernel', systemStats.kernel_version || '--');
        setText('sys-arch', systemStats.architecture || '--');
        setText('sys-processor', systemStats.processor || '--');
        // Formatear Load Average con descripción
        const loadAvg = systemStats.load_average;
        if (loadAvg) {
          const loadParts = String(loadAvg).split(',').map(s => s.trim());
          if (loadParts.length === 3) {
            setText('sys-load', `${loadParts[0]} (1m), ${loadParts[1]} (5m), ${loadParts[2]} (15m)`);
          } else {
            setText('sys-load', loadAvg);
          }
        } else {
          setText('sys-load', '--');
        }

        // Actualizar estadísticas de red
        setText('net-interface', networkStats.interface || networkStatsRaw.interface || '--');
        setText('net-ip', networkStats.ip_address || networkStatsRaw.ip_address || '--');
        
        const downloadSpeed = networkStats.download_speed || 0;
        const uploadSpeed = networkStats.upload_speed || 0;
        
        // Formatear velocidades correctamente
        const downloadText = downloadSpeed > 0 ? formatBytes(downloadSpeed) + '/s' : '0 B/s';
        const uploadText = uploadSpeed > 0 ? formatBytes(uploadSpeed) + '/s' : '0 B/s';
        
        setText('net-download', downloadText);
        setText('net-upload', uploadText);
        
        const bytesRecv = networkStats.bytes_recv || networkStatsRaw.bytes_recv || 0;
        const bytesSent = networkStats.bytes_sent || networkStatsRaw.bytes_sent || 0;
        setText('net-bytes-recv', formatBytes(bytesRecv));
        setText('net-bytes-sent', formatBytes(bytesSent));
        
        const packetsSent = networkStats.packets_sent || networkStatsRaw.packets_sent || 0;
        const packetsRecv = networkStats.packets_recv || networkStatsRaw.packets_recv || 0;
        setText('net-packets', `${packetsSent} / ${packetsRecv}`);
        
        const errors = (networkStats.errors || networkStatsRaw.errors || 0) + 
                       (networkStats.drop || networkStatsRaw.drop || 0);
        setText('net-errors', errors || '0');

        // Agregar al historial del gráfico
        const validDownloadSpeed = (typeof downloadSpeed === 'number' && !isNaN(downloadSpeed) && isFinite(downloadSpeed)) ? downloadSpeed : 0;
        const validUploadSpeed = (typeof uploadSpeed === 'number' && !isNaN(uploadSpeed) && isFinite(uploadSpeed)) ? uploadSpeed : 0;
        
        // Log para depuración
        if (validDownloadSpeed > 0 || validUploadSpeed > 0) {
          console.log('Adding to chart:', {
            download: validDownloadSpeed.toFixed(2) + ' B/s',
            upload: validUploadSpeed.toFixed(2) + ' B/s',
            historyLength: netHistory.labels.length
          });
        }
        
        pushNetHistory(validDownloadSpeed, validUploadSpeed);

        setText('monitoring-last-update', new Date().toLocaleTimeString());
        
        ensureNetChart();
        
        if (netChart) {
          // Actualizar datos del gráfico
          netChart.data.labels = [...netHistory.labels];
          netChart.data.datasets[0].data = [...netHistory.download];
          netChart.data.datasets[1].data = [...netHistory.upload];
          
          // Actualizar etiquetas de las series
          netChart.data.datasets[0].label = t('monitoring.download', 'Download');
          netChart.data.datasets[1].label = t('monitoring.upload', 'Upload');
          
          // Forzar actualización
          netChart.update('none');
          
          console.log('Chart updated with', netHistory.labels.length, 'data points');
        }
      } catch (error) {
        console.error('Error updating monitoring stats:', error);
        
        setText('uptime-value', '--');
        setText('cpu-usage', '--');
        setText('mem-usage', '--');
        setText('disk-usage', '--');
        setText('net-download', '--');
        setText('net-upload', '--');
        
        setTimeout(() => {
          updateStats();
        }, 5000);
      }
    }

    // Event listener para cambio de interfaz
    function setupEventListeners() {
      const select = document.getElementById('net-interface-select');
      if (select) {
        select.addEventListener('change', function(e) {
          selectedInterface = e.target.value || '';
          lastNetSnapshot = null;
          netHistory.labels.length = 0;
          netHistory.download.length = 0;
          netHistory.upload.length = 0;
          if (netChart) netChart.update();
          updateStats();
        });
      }
    }

    // Inicializar
    waitForHostBerry(function() {
      setupEventListeners();
      updateStats();
      setInterval(updateStats, 5000);
    });
  }
})();
</script>
{% endblock %}
