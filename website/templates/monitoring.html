{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-12 text-center">
                <h1 class="dashboard-title">
                    <i class="bi bi-activity me-2"></i>
                    {{ t('navigation.monitoring', 'Monitoring') }}
                </h1>
                <p class="dashboard-subtitle">{{ t('monitoring.subtitle', 'Real-time system monitoring and network statistics') }}</p>
                <div class="dashboard-time">
                    <i class="bi bi-clock me-1"></i>
                    {{ t('monitoring.last_update', 'Last update') }}: <span id="monitoring-last-update">--:--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Cards -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h5 class="actions-card-title">
                        <i class="bi bi-cpu me-2"></i>
                        {{ t('monitoring.system_status', 'System Status') }}
                    </h5>
                </div>
                <div class="actions-card-body">
                    <div class="row g-3">
                        <!-- Uptime -->
                        <div class="col-lg-3 col-md-6">
                            <div class="status-card cpu-card">
                                <div class="status-card-header">
                                    <div class="status-icon cpu-icon">
                                        <i class="bi bi-clock-history"></i>
                                    </div>
                                    <div class="status-info">
                                        <h6>{{ t('monitoring.uptime', 'Uptime') }}</h6>
                                        <h3 id="uptime-value">--</h3>
                                    </div>
                                </div>
                                <div class="status-footer">
                                    <span class="status-text text-white-50">{{ t('monitoring.since_boot', 'Since boot') }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- CPU Usage -->
                        <div class="col-lg-3 col-md-6">
                            <div class="status-card cpu-card">
                                <div class="status-card-header">
                                    <div class="status-icon cpu-icon">
                                        <i class="bi bi-cpu"></i>
                                    </div>
                                    <div class="status-info">
                                        <h6>{{ t('monitoring.cpu_usage', 'CPU Usage') }}</h6>
                                        <h3 id="cpu-usage">0%</h3>
                                    </div>
                                </div>
                                <div class="progress">
                                    <div id="cpu-progress" class="progress-bar cpu-progress" style="width:0%"></div>
                                </div>
                                <div class="status-footer">
                                    <span class="status-text text-white-50">
                                        {{ t('monitoring.cores', 'Cores') }}: <strong id="cpu-cores">-</strong> | 
                                        {{ t('monitoring.temp', 'Temp') }}: <strong id="cpu-temp">--°C</strong>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Memory Usage -->
                        <div class="col-lg-3 col-md-6">
                            <div class="status-card memory-card">
                                <div class="status-card-header">
                                    <div class="status-icon memory-icon">
                                        <i class="bi bi-memory"></i>
                                    </div>
                                    <div class="status-info">
                                        <h6>{{ t('monitoring.memory_usage', 'Memory Usage') }}</h6>
                                        <h3 id="mem-usage">0%</h3>
                                    </div>
                                </div>
                                <div class="progress">
                                    <div id="mem-progress" class="progress-bar memory-progress" style="width:0%"></div>
                                </div>
                                <div class="status-footer">
                                    <span class="status-text text-white-50">
                                        {{ t('monitoring.used_of', 'Used of') }} <strong id="mem-total">0 GB</strong> · 
                                        <span id="mem-free">0 GB</span> {{ t('monitoring.free', 'free') }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Disk Usage -->
                        <div class="col-lg-3 col-md-6">
                            <div class="status-card disk-card">
                                <div class="status-card-header">
                                    <div class="status-icon disk-icon">
                                        <i class="bi bi-hdd"></i>
                                    </div>
                                    <div class="status-info">
                                        <h6>{{ t('monitoring.disk_usage', 'Disk Usage') }}</h6>
                                        <h3 id="disk-usage">0%</h3>
                                    </div>
                                </div>
                                <div class="progress">
                                    <div id="disk-progress" class="progress-bar disk-progress" style="width:0%"></div>
                                </div>
                                <div class="status-footer">
                                    <span class="status-text text-white-50">
                                        {{ t('monitoring.used', 'Used') }} <strong id="disk-used">0 GB</strong> / 
                                        <span id="disk-total">0 GB</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="row mb-4">
        <div class="col-lg-6 col-md-12">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h5 class="actions-card-title">
                        <i class="bi bi-info-circle me-2"></i>
                        {{ t('monitoring.system_info', 'System Information') }}
                    </h5>
                </div>
                <div class="actions-card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.hostname', 'Hostname') }}</h6>
                            <p class="text-white mb-3" id="sys-hostname">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.os_version', 'OS Version') }}</h6>
                            <p class="text-white mb-3" id="sys-os">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.kernel', 'Kernel') }}</h6>
                            <p class="text-white mb-3" id="sys-kernel">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.architecture', 'Architecture') }}</h6>
                            <p class="text-white mb-3" id="sys-arch">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.processor', 'Processor') }}</h6>
                            <p class="text-white mb-3" id="sys-processor">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.load_average', 'Load Average') }}</h6>
                            <p class="text-white mb-3" id="sys-load">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Statistics -->
        <div class="col-lg-6 col-md-12">
            <div class="actions-card">
                <div class="actions-card-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="actions-card-title mb-0">
                            <i class="bi bi-wifi me-2"></i>
                            {{ t('monitoring.network_stats', 'Network Statistics') }}
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            <select class="form-select form-select-sm bg-dark text-white border-secondary" id="net-interface-select" style="min-width: 150px;">
                                <option value="">{{ t('monitoring.network_auto', 'Auto detect') }}</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="actions-card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.interface', 'Interface') }}</h6>
                            <p class="text-white mb-3" id="net-interface">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.ip_address', 'IP Address') }}</h6>
                            <p class="text-white mb-3" id="net-ip">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.download', 'Download') }}</h6>
                            <p class="text-white mb-2" id="net-download" style="font-size: 1.2rem; font-weight: 600;">0 KB/s</p>
                            <small class="text-white-50">{{ t('monitoring.total_received', 'Total Rx') }}: <span id="net-bytes-recv">0 MB</span></small>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.upload', 'Upload') }}</h6>
                            <p class="text-white mb-2" id="net-upload" style="font-size: 1.2rem; font-weight: 600;">0 KB/s</p>
                            <small class="text-white-50">{{ t('monitoring.total_sent', 'Total Tx') }}: <span id="net-bytes-sent">0 MB</span></small>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.packets', 'Packets') }}</h6>
                            <p class="text-white mb-3" id="net-packets">--</p>
                        </div>
                        <div class="col-6">
                            <h6 class="text-white-50 mb-1">{{ t('monitoring.errors', 'Errors') }}</h6>
                            <p class="text-white mb-3" id="net-errors">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="actions-card">
                <div class="actions-card-header">
                    <h5 class="actions-card-title">
                        <i class="bi bi-graph-up me-2"></i>
                        {{ t('monitoring.network_chart', 'Network Traffic Chart') }}
                    </h5>
                </div>
                <div class="actions-card-body">
                    <canvas id="net-chart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  // Función para obtener traducciones
  function getTranslation(key, defaultValue) {
    if (!key) return defaultValue || '';
    
    const keys = String(key).split('.');
    
    // 1. Intentar desde HostBerry.translations
    if (window.HostBerry?.translations) {
      let current = window.HostBerry.translations;
      for (const k of keys) {
        if (current && typeof current === 'object' && k in current) {
          current = current[k];
        } else {
          current = null;
          break;
        }
      }
      if (typeof current === 'string' && current) return current;
    }
    
    // 2. Intentar desde window.translations
    if (window.translations) {
      let current = window.translations;
      for (const k of keys) {
        if (current && typeof current === 'object' && k in current) {
          current = current[k];
        } else {
          current = null;
          break;
        }
      }
      if (typeof current === 'string' && current) return current;
    }
    
    // 3. Intentar desde el JSON embebido
    try {
      const i18nEl = document.getElementById('i18n-json');
      if (i18nEl) {
        const translations = JSON.parse(i18nEl.textContent || i18nEl.innerText || '{}');
        let current = translations;
        for (const k of keys) {
          if (current && typeof current === 'object' && k in current) {
            current = current[k];
          } else {
            current = null;
            break;
          }
        }
        if (typeof current === 'string' && current) return current;
      }
    } catch (e) {
      // Ignorar errores
    }
    
    // 4. Usar HostBerry.t si está disponible
    if (window.HostBerry?.t) {
      try {
        const result = window.HostBerry.t(key, defaultValue);
        if (result && result !== key && typeof result === 'string') return result;
      } catch (e) {
        // Ignorar errores
      }
    }
    
    // 5. Fallback al valor por defecto
    return defaultValue || key;
  }

  const setText = (id, value) => {
    const el = document.getElementById(id);
    if(el) el.textContent = value;
  };

  function safeToFixed(value, digits = 1){
    if(value === null || value === undefined) return '0.0';
    const num = typeof value === 'number' ? value : parseFloat(value);
    if(Number.isNaN(num) || !Number.isFinite(num)) return '0.0';
    return num.toFixed(digits);
  }

  function formatUptime(seconds){
    if(!Number.isFinite(seconds) || seconds < 0) return '--';
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 86400) / 3600) % 60;
    const secs = Math.floor(seconds % 60);
    if(days > 0) return `${days}d ${hours}h ${minutes}m`;
    if(hours > 0) return `${hours}h ${minutes}m`;
    if(minutes > 0) return `${minutes}m ${secs}s`;
    return `${secs}s`;
  }

  function formatBytes(bytes){
    if(!Number.isFinite(bytes) || bytes < 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${safeToFixed(bytes / Math.pow(k, i), 1)} ${sizes[i]}`;
  }

  // Esperar a que HostBerry esté disponible
  function waitForHostBerry(callback, maxAttempts = 50) {
    if (window.HostBerry && window.HostBerry.apiRequest) {
      callback();
    } else if (maxAttempts > 0) {
      setTimeout(() => waitForHostBerry(callback, maxAttempts - 1), 100);
    } else {
      console.error('HostBerry not available after waiting');
      // Fallback: crear funciones básicas
      if (!window.HostBerry) window.HostBerry = {};
      if (!window.HostBerry.apiRequest) {
        window.HostBerry.apiRequest = async function(url, options) {
          const token = localStorage.getItem('access_token');
          const opts = Object.assign({ method: 'GET', headers: {} }, options || {});
          const headers = new Headers(opts.headers);
          if (!headers.has('Authorization') && token) {
            headers.set('Authorization', 'Bearer ' + token);
          }
          opts.headers = headers;
          return await fetch(url, opts);
        };
      }
      callback();
    }
  }

  async function fetchJson(url){
    try {
      // Asegurar que HostBerry.apiRequest esté disponible
      if (!window.HostBerry || !window.HostBerry.apiRequest) {
        // Fallback: usar fetch directamente
        const token = localStorage.getItem('access_token');
        const resp = await fetch(url, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if(resp.status === 401){
          window.location.href = '/login';
          throw new Error('Unauthorized');
        }
        
        if(!resp.ok){
          let errText = '';
          try {
            errText = await resp.text();
          } catch(e) {
            errText = `HTTP ${resp.status} ${resp.statusText}`;
          }
          throw new Error(errText);
        }
        
        const data = await resp.json();
        return data.data !== undefined ? data.data : data;
      }
      
      // Usar HostBerry.apiRequest
      const resp = await window.HostBerry.apiRequest(url);
      if(!resp){
        throw new Error('No response from server');
      }
      
      if(resp.status === 401){
        window.location.href = '/login';
        throw new Error('Unauthorized');
      }
      
      if(!resp.ok){
        let errText = '';
        try {
          errText = await resp.text();
        } catch(e) {
          errText = `HTTP ${resp.status} ${resp.statusText}`;
        }
        throw new Error(errText);
      }
      
      const data = await resp.json();
      // Si la respuesta tiene 'data', usarlo; si no, usar directamente
      if(data && typeof data === 'object' && 'data' in data){
        return data.data;
      }
      return data;
    } catch(error){
      console.error('fetchJson error:', url, error);
      throw error;
    }
  }

  let selectedInterface = '';
  let lastNetSnapshot = null;
  let netChart = null;
  const netHistory = { labels: [], download: [], upload: [] };

  function updateProgress(id, percent){
    const el = document.getElementById(id);
    if(el){
      const safePercent = Math.min(100, Math.max(0, percent));
      el.style.width = safePercent + '%';
    }
  }

  function populateInterfaceSelect(interfaces){
    const select = document.getElementById('net-interface-select');
    if(!select) return;
    
    // Si interfaces es un array de strings o objetos
    if(Array.isArray(interfaces) && interfaces.length > 0){
      // Limpiar opciones existentes excepto "Auto detect"
      while(select.options.length > 1){
        select.remove(1);
      }
      
      interfaces.forEach(iface => {
        // Manejar tanto strings como objetos
        const ifaceName = (typeof iface === 'string') ? iface : (iface.name || iface);
        if(ifaceName && ifaceName !== 'lo'){
          const option = document.createElement('option');
          option.value = ifaceName;
          option.textContent = ifaceName;
          if(ifaceName === selectedInterface){
            option.selected = true;
          }
          select.appendChild(option);
        }
      });
    }
  }

  function computeNetworkRates(current){
    if(!current || typeof current !== 'object'){
      return {
        download_speed: 0.0,
        upload_speed: 0.0,
        bytes_recv: 0,
        bytes_sent: 0,
        packets_sent: 0,
        packets_recv: 0,
        errors: 0,
        interface: selectedInterface || '',
        ip_address: '--',
        interfaces: []
      };
    }
    
    const bytesRecv = typeof current.bytes_recv === 'number' && !isNaN(current.bytes_recv) ? current.bytes_recv : 0;
    const bytesSent = typeof current.bytes_sent === 'number' && !isNaN(current.bytes_sent) ? current.bytes_sent : 0;
    
    if(lastNetSnapshot && current.interface && lastNetSnapshot.interface && current.interface !== lastNetSnapshot.interface){
      lastNetSnapshot = null;
      netHistory.labels.length = 0;
      netHistory.download.length = 0;
      netHistory.upload.length = 0;
      if(netChart){ netChart.update(); }
    }
    
    const now = Date.now();
    if(!lastNetSnapshot){
      lastNetSnapshot = { 
        time: now, 
        bytes_recv: bytesRecv,
        bytes_sent: bytesSent,
        interface: current.interface || selectedInterface || ''
      };
      return {
        ...current,
        download_speed: 0.0,
        upload_speed: 0.0,
        bytes_recv: bytesRecv,
        bytes_sent: bytesSent
      };
    }
    
    const timeDelta = (now - lastNetSnapshot.time) / 1000;
    if(timeDelta <= 0) return { ...current, download_speed: 0.0, upload_speed: 0.0 };
    
    const bytesRecvDelta = bytesRecv - lastNetSnapshot.bytes_recv;
    const bytesSentDelta = bytesSent - lastNetSnapshot.bytes_sent;
    
    const downloadSpeed = bytesRecvDelta / timeDelta;
    const uploadSpeed = bytesSentDelta / timeDelta;
    
    lastNetSnapshot = {
      time: now,
      bytes_recv: bytesRecv,
      bytes_sent: bytesSent,
      interface: current.interface || selectedInterface || ''
    };
    
    return {
      ...current,
      download_speed: downloadSpeed,
      upload_speed: uploadSpeed,
      bytes_recv: bytesRecv,
      bytes_sent: bytesSent
    };
  }

  function pushNetHistory(download, upload){
    // Asegurar que los valores sean números válidos
    const downloadValue = (typeof download === 'number' && !isNaN(download) && isFinite(download)) ? download : 0;
    const uploadValue = (typeof upload === 'number' && !isNaN(upload) && isFinite(upload)) ? upload : 0;
    
    const now = new Date();
    const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                      now.getMinutes().toString().padStart(2, '0') + ':' + 
                      now.getSeconds().toString().padStart(2, '0');
    
    netHistory.labels.push(timeLabel);
    netHistory.download.push(Math.max(0, downloadValue));
    netHistory.upload.push(Math.max(0, uploadValue));
    
    if(netHistory.labels.length > 30){
      netHistory.labels.shift();
      netHistory.download.shift();
      netHistory.upload.shift();
    }
  }

  function ensureNetChart(){
    const canvas = document.getElementById('net-chart');
    if(!canvas) {
      console.warn('Canvas element not found');
      return;
    }
    
    if(netChart) return;
    
    // Verificar que Chart.js esté disponible
    if(typeof Chart === 'undefined'){
      console.warn('Chart.js not loaded yet, retrying...');
      setTimeout(ensureNetChart, 500);
      return;
    }
    
    // Inicializar con algunos datos por defecto si está vacío
    if(netHistory.labels.length === 0){
      const now = new Date();
      for(let i = 9; i >= 0; i--){
        const time = new Date(now.getTime() - i * 1000);
        const timeLabel = time.getHours().toString().padStart(2, '0') + ':' + 
                          time.getMinutes().toString().padStart(2, '0') + ':' + 
                          time.getSeconds().toString().padStart(2, '0');
        netHistory.labels.push(timeLabel);
        netHistory.download.push(0);
        netHistory.upload.push(0);
      }
    }
    
    try {
      const ctx = canvas.getContext('2d');
      netChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: netHistory.labels,
          datasets: [
            {
              label: getTranslation('monitoring.download', 'Download'),
              data: netHistory.download,
              borderColor: '#0dcaf0',
              backgroundColor: 'rgba(13, 202, 240, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 0,
              pointHoverRadius: 4
            },
            {
              label: getTranslation('monitoring.upload', 'Upload'),
              data: netHistory.upload,
              borderColor: '#198754',
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 0,
              pointHoverRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 0
          },
          plugins: {
            legend: {
              labels: { color: '#fff' },
              display: true
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: { 
              ticks: { color: '#fff', maxRotation: 45, minRotation: 0 },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: { 
              ticks: { 
                color: '#fff',
                callback: function(value) {
                  return formatBytes(value) + '/s';
                }
              },
              grid: { color: 'rgba(255,255,255,0.1)' },
              beginAtZero: true
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
      console.log('Network chart initialized successfully');
    } catch (error) {
      console.error('Error creating network chart:', error);
    }
  }

  async function updateStats(){
    try{
      console.log('Fetching monitoring stats...');
      const [systemStatsResp, networkStatsResp] = await Promise.all([
        fetchJson('/api/v1/system/stats'),
        fetchJson(`/api/v1/system/network${selectedInterface ? `?interface=${encodeURIComponent(selectedInterface)}` : ''}`)
      ]);
      
      console.log('System stats response:', systemStatsResp);
      console.log('Network stats response:', networkStatsResp);
      
      // Los datos vienen directamente del endpoint (ya no están envueltos en 'data')
      let systemStats = systemStatsResp;
      if(!systemStats || typeof systemStats !== 'object'){
        console.error('Invalid system stats response:', systemStatsResp);
        throw new Error('Invalid system stats response');
      }
      
      let networkStatsRaw = networkStatsResp;
      if(!networkStatsRaw || typeof networkStatsRaw !== 'object'){
        console.error('Invalid network stats response:', networkStatsResp);
        throw new Error('Invalid network stats response');
      }
      
      console.log('Parsed system stats:', systemStats);
      console.log('Parsed network stats:', networkStatsRaw);
      
      const networkStats = computeNetworkRates(networkStatsRaw);
      
      if(networkStats.interfaces && Array.isArray(networkStats.interfaces)){
        populateInterfaceSelect(networkStats.interfaces);
      } else if(networkStatsRaw.interfaces && Array.isArray(networkStatsRaw.interfaces)){
        populateInterfaceSelect(networkStatsRaw.interfaces);
      }

      console.log('System stats received:', systemStats);
      
      // Actualizar uptime
      const uptime = systemStats.uptime || systemStats.uptime_seconds || 0;
      setText('uptime-value', formatUptime(uptime));
      
      // Actualizar CPU - usar los campos correctos del modelo
      const cpuUsage = systemStats.cpu_usage;
      let cpuUsageValue = 0;
      if(cpuUsage !== null && cpuUsage !== undefined){
        cpuUsageValue = typeof cpuUsage === 'number' ? cpuUsage : parseFloat(cpuUsage);
        if(Number.isNaN(cpuUsageValue)) cpuUsageValue = 0;
      }
      console.log('CPU Usage:', cpuUsage, '->', cpuUsageValue);
      setText('cpu-usage', `${safeToFixed(cpuUsageValue)}%`);
      updateProgress('cpu-progress', cpuUsageValue);
      
      const cpuTemp = systemStats.cpu_temperature || 0;
      if(typeof cpuTemp === 'number' && cpuTemp > 0){
        setText('cpu-temp', `${safeToFixed(cpuTemp)}°C`);
      } else {
        setText('cpu-temp', '--°C');
      }
      
      const cpuCores = systemStats.cpu_cores || 0;
      setText('cpu-cores', cpuCores ? String(cpuCores) : '-');

      // Actualizar Memoria - usar los campos correctos del modelo
      const memUsage = systemStats.memory_usage;
      let memUsageValue = 0;
      if(memUsage !== null && memUsage !== undefined){
        memUsageValue = typeof memUsage === 'number' ? memUsage : parseFloat(memUsage);
        if(Number.isNaN(memUsageValue)) memUsageValue = 0;
      }
      console.log('Memory Usage:', memUsage, '->', memUsageValue);
      setText('mem-usage', `${safeToFixed(memUsageValue)}%`);
      updateProgress('mem-progress', memUsageValue);
      
      const memTotal = systemStats.memory_total || 0;
      if(memTotal && memTotal > 0){
        setText('mem-total', formatBytes(memTotal));
      } else {
        setText('mem-total', '0 GB');
      }
      
      const memFree = systemStats.memory_free || 0;
      if(memFree && memFree > 0){
        setText('mem-free', formatBytes(memFree));
      } else {
        setText('mem-free', '0 GB');
      }

      // Actualizar Disco - usar los campos correctos del modelo
      const diskUsage = systemStats.disk_usage;
      let diskUsageValue = 0;
      if(diskUsage !== null && diskUsage !== undefined){
        diskUsageValue = typeof diskUsage === 'number' ? diskUsage : parseFloat(diskUsage);
        if(Number.isNaN(diskUsageValue)) diskUsageValue = 0;
      }
      console.log('Disk Usage:', diskUsage, '->', diskUsageValue);
      setText('disk-usage', `${safeToFixed(diskUsageValue)}%`);
      updateProgress('disk-progress', diskUsageValue);
      
      const diskTotal = systemStats.disk_total || 0;
      if(diskTotal && diskTotal > 0){
        setText('disk-total', formatBytes(diskTotal));
      } else {
        setText('disk-total', '0 GB');
      }
      
      const diskUsed = systemStats.disk_used || 0;
      if(diskUsed && diskUsed > 0){
        setText('disk-used', formatBytes(diskUsed));
      } else {
        setText('disk-used', '0 GB');
      }

      // Actualizar información del sistema - ahora viene en stats_dict
      setText('sys-hostname', systemStats.hostname || '--');
      setText('sys-os', systemStats.os_version || '--');
      setText('sys-kernel', systemStats.kernel_version || '--');
      setText('sys-arch', systemStats.architecture || '--');
      setText('sys-processor', systemStats.processor || '--');
      setText('sys-load', systemStats.load_average || '--');
      
      // Si no está en stats, intentar obtener desde /api/v1/system/info
      if(!systemStats.hostname && !systemStats.os_version){
        fetchJson('/api/v1/system/info').then(info => {
          const systemInfo = info.data || info;
          if(systemInfo){
            setText('sys-hostname', systemInfo.hostname || '--');
            setText('sys-os', systemInfo.os_name || systemInfo.platform || '--');
            setText('sys-kernel', systemInfo.kernel_version || '--');
            setText('sys-arch', systemInfo.processor || '--');
            setText('sys-processor', systemInfo.processor || '--');
            if(systemInfo.load_average && Array.isArray(systemInfo.load_average)){
              setText('sys-load', systemInfo.load_average.map(l => safeToFixed(l, 2)).join(', '));
            } else {
              setText('sys-load', '--');
            }
          }
        }).catch(err => {
          console.warn('Could not fetch system info:', err);
        });
      }

      // Actualizar estadísticas de red
      setText('net-interface', networkStats.interface || networkStatsRaw.interface || '--');
      setText('net-ip', networkStats.ip_address || networkStatsRaw.ip_address || '--');
      
      const downloadSpeed = networkStats.download_speed || 0;
      const uploadSpeed = networkStats.upload_speed || 0;
      setText('net-download', formatBytes(downloadSpeed) + '/s');
      setText('net-upload', formatBytes(uploadSpeed) + '/s');
      
      const bytesRecv = networkStats.bytes_recv || networkStatsRaw.bytes_recv || 0;
      const bytesSent = networkStats.bytes_sent || networkStatsRaw.bytes_sent || 0;
      setText('net-bytes-recv', formatBytes(bytesRecv));
      setText('net-bytes-sent', formatBytes(bytesSent));
      
      const packetsSent = networkStats.packets_sent || networkStatsRaw.packets_sent || 0;
      const packetsRecv = networkStats.packets_recv || networkStatsRaw.packets_recv || 0;
      setText('net-packets', `${packetsSent} / ${packetsRecv}`);
      
      const errors = (networkStats.errors || networkStatsRaw.errors || 0) + 
                     (networkStats.drop || networkStatsRaw.drop || 0);
      setText('net-errors', errors || '0');

      pushNetHistory(downloadSpeed, uploadSpeed);

      setText('monitoring-last-update', new Date().toLocaleTimeString());
      ensureNetChart();
      
      if(netChart){
        netChart.update();
      }
    }catch(error){
      console.error('Error updating monitoring stats:', error);
      
      // Establecer valores por defecto
      setText('uptime-value', '--');
      setText('cpu-usage', '--');
      setText('mem-usage', '--');
      setText('disk-usage', '--');
      setText('net-download', '--');
      setText('net-upload', '--');
      
      // Reintentar después de 5 segundos
      setTimeout(() => {
        console.log('Retrying monitoring stats...');
        updateStats();
      }, 5000);
    }
  }

  // Event listener para cambio de interfaz
  document.getElementById('net-interface-select')?.addEventListener('change', function(e){
    selectedInterface = e.target.value || '';
    lastNetSnapshot = null;
    netHistory.labels.length = 0;
    netHistory.download.length = 0;
    netHistory.upload.length = 0;
    if(netChart){ netChart.update(); }
    updateStats();
  });

  // Función para inicializar monitoring
  function initMonitoring() {
    console.log('Monitoring page initialized');
    
    // Configurar event listener para cambio de interfaz
    const select = document.getElementById('net-interface-select');
    if(select){
      select.addEventListener('change', function(e){
        selectedInterface = e.target.value || '';
        lastNetSnapshot = null;
        netHistory.labels.length = 0;
        netHistory.download.length = 0;
        netHistory.upload.length = 0;
        if(netChart){ netChart.update(); }
        updateStats();
      });
    }
    
    // Esperar un poco para que Chart.js se cargue y luego iniciar actualizaciones
    setTimeout(function(){
      updateStats();
      setInterval(updateStats, 5000);
    }, 500);
  }
  
  // Esperar a que HostBerry esté disponible y luego inicializar
  function startInit() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        waitForHostBerry(initMonitoring);
      });
    } else {
      // DOM ya está listo
      waitForHostBerry(initMonitoring);
    }
  }
  
  // Iniciar
  startInit();
})();
</script>
{% endblock %}
