{{ define "base.html" }}
<!DOCTYPE html>
<html lang="{{ .language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HostBerry</title>
    <meta name="description" content="{{ call .t "common.app_description" "HostBerry - Network Management System for Raspberry Pi" }}">
    <link rel="icon" type="image/png" href="/static/hostberry.png">
    <link rel="shortcut icon" type="image/png" href="/static/hostberry.png">
    <link rel="apple-touch-icon" href="/static/hostberry.png">
    
    <!-- CSS offline HostBerry -->
    <link href="/static/css/hostberry.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    
    <!-- Prevenir layout shifts -->
    <style>
        html, body {
            min-height: 100vh;
            overflow-x: hidden;
        }
        .dashboard-container {
            min-height: calc(100vh - 200px);
        }
        /* Prevenir reflows durante la carga */
        * {
            box-sizing: border-box;
        }
        /* Suavizar transiciones de tama침o */
        body {
            transition: min-height 0.3s ease-out;
        }
    </style>
    
    {{ block "extra_css" . }}{{ end }}
</head>
<body>
    {{ block "navbar" . }}
    <nav class="navbar navbar-expand-lg navbar-dark glass-navbar sticky-top mb-4">
        <div class="container-fluid px-4">
            <button class="navbar-toggler border-0 me-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="d-flex align-items-center gap-3">
                <a class="navbar-brand d-flex align-items-center" href="/dashboard">
                    <img src="/static/hostberry.png" alt="HostBerry" style="height: 32px;">
                </a>
                
                <!-- User Profile Dropdown -->
                {{ if .current_user }}
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center user-dropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="user-avatar bg-white text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <span id="hb-current-username" class="d-none d-md-inline ms-2">{{ .current_user.Username }}</span>
                    </a>
                    <ul class="dropdown-menu border-0 shadow-sm rounded-3 mt-2">
                        <li><div class="dropdown-header text-muted">{{ call .t "navigation.account" "Account" }}</div></li>
                        <li><a class="dropdown-item" href="/profile">
                            <i class="bi bi-person me-2"></i>
                            {{ call .t "navigation.profile" "Profile" }}
                        </a></li>
                        <li><a class="dropdown-item" href="/settings">
                            <i class="bi bi-gear me-2"></i>
                            {{ call .t "navigation.settings" "Settings" }}
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" data-action="logout">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            {{ call .t "navigation.logout" "Logout" }}
                        </a></li>
                    </ul>
                </div>
                {{ end }}
            </div>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>
                            {{ call .t "navigation.dashboard" "Dashboard" }}
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="networkDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-hdd-network me-1"></i>
                            {{ call .t "navigation.network" "Network" }}
                        </a>
                        <ul class="dropdown-menu border-0 shadow-sm rounded-3">
                            <li><a class="dropdown-item" href="/network"><i class="bi bi-ethernet me-2"></i>{{ call .t "navigation.network" "Network" }}</a></li>
                            <li><a class="dropdown-item" href="/wifi"><i class="bi bi-wifi me-2"></i>{{ call .t "navigation.wifi" "WiFi" }}</a></li>
                            <li><a class="dropdown-item" href="/hostapd"><i class="bi bi-router me-2"></i>{{ call .t "navigation.hostapd" "Hotspot" }}</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="securityDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-shield-lock me-1"></i>
                            {{ call .t "navigation.security" "Security" }}
                        </a>
                        <ul class="dropdown-menu border-0 shadow-sm rounded-3">
                            <li><a class="dropdown-item" href="/vpn"><i class="bi bi-shield-lock me-2"></i>{{ call .t "navigation.vpn" "VPN" }}</a></li>
                            <li><a class="dropdown-item" href="/wireguard"><i class="bi bi-shield-check me-2"></i>{{ call .t "navigation.wireguard" "WireGuard" }}</a></li>
                            <li><a class="dropdown-item" href="/adblock"><i class="bi bi-shield-x me-2"></i>{{ call .t "navigation.adblock" "AdBlock" }}</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {{ end }}

    <div class="dropdown lang-dropdown">
        <button class="btn lang-toggle dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            {{ if eq .language "es" }}ES{{ else }}EN{{ end }}
        </button>
        <ul class="dropdown-menu lang-dropdown-menu">
            <li><a class="dropdown-item" href="?lang=es">游쀯릖 Espa침ol</a></li>
            <li><a class="dropdown-item" href="?lang=en">游쥟릖 English</a></li>
        </ul>
    </div>

    <button id="theme-toggle" class="theme-toggle" type="button" title="{{ call .t "common.change_theme" "Change theme" }}" aria-label="{{ call .t "common.change_theme" "Change theme" }}" onclick="toggleTheme()"></button>

    <div class="container-fluid mt-4">
        {{ block "content" . }}{{ end }}
    </div>

    {{ if .translations }}
    <script id="i18n-json" type="application/json">{{ .translations_json }}</script>
    {{ end }}

    {{ if .settings }}
    <script>
      // Settings globales provenientes del backend (DB): language/theme/timezone
      window.HostBerryServerSettings = {{ .settings_json }};
    </script>
    {{ end }}

    <script src="/static/js/common.js"></script>
    <script src="/static/js/theme.js"></script>
    
    <!-- Auto-refresh global cada 60 segundos -->
    <script>
    (function() {
        let userActive = true;
        let lastActivity = Date.now();
        
        // Detectar actividad del usuario
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(function(event) {
            document.addEventListener(event, function() {
                userActive = true;
                lastActivity = Date.now();
            }, { passive: true });
        });
        
        // Recargar la p치gina cada 60 segundos si el usuario est치 inactivo
        // Prevenir layout shift durante el reload
        let refreshScheduled = false;
        setInterval(function() {
            if (refreshScheduled) return;
            
            const timeSinceActivity = Date.now() - lastActivity;
            
            // Solo recargar si:
            // - No hay modales abiertos
            // - No hay inputs/textarea con foco
            // - El usuario ha estado inactivo por al menos 5 segundos
            // - La p치gina est치 completamente cargada
            if (timeSinceActivity >= 5000 && 
                !document.querySelector('.modal.show') && 
                document.activeElement.tagName !== 'INPUT' &&
                document.activeElement.tagName !== 'TEXTAREA' &&
                document.activeElement.tagName !== 'SELECT' &&
                document.readyState === 'complete') {
                
                refreshScheduled = true;
                // Prevenir layout shift fijando la altura antes del reload
                const currentHeight = Math.max(
                    document.documentElement.scrollHeight,
                    document.documentElement.clientHeight,
                    document.body.scrollHeight,
                    document.body.clientHeight
                );
                
                // Fijar altura para evitar cambios visuales durante el reload
                document.documentElement.style.minHeight = currentHeight + 'px';
                document.body.style.minHeight = currentHeight + 'px';
                document.documentElement.style.overflow = 'hidden';
                
                // Peque침o delay para que el navegador aplique los estilos antes del reload
                setTimeout(function() {
                    window.location.reload();
                }, 50);
            }
        }, 60000); // 60 segundos = 60000 milisegundos
    })();
    </script>
    
    {{ block "extra_js" . }}{{ end }}
</body>
</html>
